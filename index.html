<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWCH IT Work Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Date Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <style>
        /* Custom styles */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Priority Colors */
        .priority-urgent { background-color: #ef4444 !important; color: white !important; }
        .priority-high { background-color: #f97316 !important; color: white !important; }
        .priority-medium { background-color: #eab308 !important; color: black !important; }
        .priority-low { background-color: #22c55e !important; color: white !important; }
        
        /* Progress Bar */
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            background: #e5e7eb;
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        /* Dark Mode */
        .dark { background-color: #111827; color: #f3f4f6; }
        .dark .bg-white { background-color: #1f2937 !important; }
        .dark .bg-gray-100 { background-color: #374151 !important; }
        .dark .text-gray-800 { color: #f3f4f6 !important; }
        .dark .border-gray-300 { border-color: #4b5563 !important; }
        .dark .bg-blue-600 { background-color: #2563eb !important; }
        
        /* Task cell styles */
        .task-cell {
            word-wrap: break-word;
            white-space: normal;
            max-width: 250px;
            min-width: 150px;
        }
        
        /* Mobile menu overlay */
        .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 30;
        }
        
        /* Profile image styles */
        .profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #4b5563;
        }
        
        /* Kanban Board */
        .kanban-column {
            min-height: 500px;
            background: #f8fafc;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        .kanban-task {
            cursor: grab;
            margin-bottom: 0.75rem;
            transition: all 0.2s ease;
        }
        
        .kanban-task:active {
            cursor: grabbing;
        }
        
        /* Dark mode for kanban */
        .dark .kanban-column {
            background: #374151;
        }
        
        /* Search highlight */
        .search-highlight {
            background-color: #fef3c7;
            padding: 2px 0;
        }
        
        .dark .search-highlight {
            background-color: #92400e;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        .dark ::-webkit-scrollbar-track {
            background: #374151;
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: #6b7280;
        }
        
        /* PWA Install Prompt */
        .pwa-install-prompt {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 transition-colors duration-200">
    <!-- PWA Install Prompt -->
    <div id="pwaInstallPrompt" class="pwa-install-prompt hidden">
        <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-4 w-64 border border-gray-200 dark:border-gray-700">
            <div class="flex items-center mb-3">
                <i class="fas fa-mobile-alt text-blue-500 text-xl mr-2"></i>
                <h3 class="font-semibold">Install App</h3>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-3">Install AWCH Tracker for better experience</p>
            <div class="flex gap-2">
                <button onclick="installPWA()" class="flex-1 bg-blue-500 text-white py-2 rounded text-sm hover:bg-blue-600">Install</button>
                <button onclick="dismissPWA()" class="flex-1 border border-gray-300 dark:border-gray-600 py-2 rounded text-sm">Later</button>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md border border-gray-200 dark:border-gray-700">
            <h1 class="text-2xl font-bold text-blue-600 dark:text-blue-400 text-center mb-2">AWCH IT Work Tracker</h1>
            <p class="text-gray-600 dark:text-gray-300 text-center mb-6">Track and manage your tasks efficiently</p>
            
            <form id="loginForm" onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Username</label>
                    <input type="text" id="loginUsername" required 
                           class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Enter your username">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                    <input type="password" id="loginPassword" required 
                           class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Enter your password">
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="rememberMe" class="mr-2">
                    <label for="rememberMe" class="text-sm text-gray-600 dark:text-gray-300">Remember me</label>
                </div>
                
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition flex items-center justify-center">
                    <span id="loginBtnText">Login to Dashboard</span>
                    <span id="loginLoading" class="hidden loading ml-2"></span>
                </button>
            </form>
        </div>
    </div>

    <!-- Main App (Initially Hidden) -->
    <div id="appContainer" class="hidden min-h-screen flex">
        <!-- Mobile Menu Overlay -->
        <div id="mobileMenuOverlay" class="mobile-menu-overlay hidden md:hidden" onclick="toggleMenu()"></div>
        
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed md:static z-40 inset-y-0 left-0 w-64 bg-white dark:bg-gray-800 border-r dark:border-gray-700 transform -translate-x-full md:translate-x-0 transition">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-xl font-bold text-blue-600 dark:text-blue-400">AWCH IT Tracker</h1>
                    <button onclick="toggleDarkMode()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i id="darkModeIcon" class="fas fa-moon"></i>
                    </button>
                </div>
                
                <!-- User Profile in Sidebar -->
                <div class="mt-4 flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div id="userProfileImage" class="profile-img">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p id="sidebarUserName" class="text-sm font-medium text-gray-900 dark:text-white truncate"></p>
                        <p id="sidebarUserRole" class="text-xs text-gray-500 dark:text-gray-400"></p>
                    </div>
                    <button onclick="toggleUserProfile()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                
                <!-- User Profile Dropdown -->
                <div id="userProfileDropdown" class="hidden mt-2 bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg shadow-lg p-4 space-y-3">
                    <div class="text-center">
                        <div id="dropdownProfileImage" class="profile-img mx-auto mb-2" style="width: 60px; height: 60px; font-size: 24px;">
                            <i class="fas fa-user"></i>
                        </div>
                        <h3 id="dropdownUserName" class="font-semibold dark:text-white"></h3>
                        <p id="dropdownUserRole" class="text-sm text-gray-500 dark:text-gray-400"></p>
                    </div>
                    
                    <div class="border-t dark:border-gray-700 pt-3 space-y-2">
                        <button onclick="openChangePassword()" class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center space-x-2">
                            <i class="fas fa-key w-4"></i>
                            <span>Change Password</span>
                        </button>
                        <button onclick="logout()" class="w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded flex items-center space-x-2">
                            <i class="fas fa-sign-out-alt w-4"></i>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
                
                <!-- Search Box -->
                <div class="mt-4">
                    <div class="relative">
                        <input type="text" id="globalSearch" 
                               placeholder="Search tasks..." 
                               class="w-full pl-10 pr-4 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               onkeyup="handleGlobalSearch(event)">
                        <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                        <button onclick="clearSearch()" class="absolute right-3 top-2.5 text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <nav class="mt-6 space-y-2">
                    <button onclick="setPage('Dashboard')" class="menuBtn w-full text-left px-4 py-2 rounded bg-blue-600 text-white flex items-center space-x-2">
                        <i class="fas fa-tachometer-alt w-4"></i>
                        <span>Dashboard</span>
                    </button>
                    <button onclick="setPage('My Tasks')" class="menuBtn w-full text-left px-4 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2">
                        <i class="fas fa-tasks w-4"></i>
                        <span>My Tasks</span>
                    </button>
                    <button onclick="setPage('Done by Me')" class="menuBtn w-full text-left px-4 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2">
                        <i class="fas fa-check-circle w-4"></i>
                        <span>Done by Me</span>
                    </button>
                    <button onclick="setPage('Kanban Board')" class="menuBtn w-full text-left px-4 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2">
                        <i class="fas fa-columns w-4"></i>
                        <span>Kanban Board</span>
                    </button>
                    <button onclick="setPage('Analytics')" class="menuBtn w-full text-left px-4 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2">
                        <i class="fas fa-chart-bar w-4"></i>
                        <span>Analytics</span>
                    </button>
                    
                    <!-- Admin Only Menu -->
                    <div id="adminMenu" class="hidden mt-4 pt-4 border-t dark:border-gray-700">
                        <h3 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-2">Admin Panel</h3>
                        <button onclick="setPage('Manage Users')" class="menuBtn w-full text-left px-4 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2">
                            <i class="fas fa-users w-4"></i>
                            <span>Manage Users</span>
                        </button>
                        <button onclick="setPage('Deleted Tasks')" class="menuBtn w-full text-left px-4 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2">
                            <i class="fas fa-trash w-4"></i>
                            <span>Deleted Tasks</span>
                        </button>
                        <button onclick="setPage('Reports')" class="menuBtn w-full text-left px-4 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2">
                            <i class="fas fa-file-alt w-4"></i>
                            <span>Reports</span>
                        </button>
                    </div>
                </nav>
                
                <!-- Filter Section -->
                <div class="mt-8 pt-4 border-t dark:border-gray-700">
                    <h3 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-2">Filters</h3>
                    <div class="space-y-2">
                        <select id="filterPriority" onchange="applyFilters()" class="w-full text-sm border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded px-3 py-1.5">
                            <option value="">All Priorities</option>
                            <option value="Urgent">Urgent</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                        <select id="filterStatus" onchange="applyFilters()" class="w-full text-sm border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded px-3 py-1.5">
                            <option value="">All Status</option>
                            <option value="Pending">Pending</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Done">Done</option>
                        </select>
                        <input type="date" id="filterDate" onchange="applyFilters()" 
                               class="w-full text-sm border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded px-3 py-1.5">
                    </div>
                </div>
                
                <div class="mt-8 text-xs text-gray-500 dark:text-gray-400">
                    <p id="dbStatusText">Connecting to database...</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col min-w-0">
            <header class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 px-4 py-3 flex justify-between items-center min-w-0">
                <div class="flex items-center gap-3 min-w-0">
                    <button class="md:hidden" onclick="toggleMenu()">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <h2 id="pageTitle" class="font-semibold truncate dark:text-white">Dashboard</h2>
                </div>
                
                <!-- Header Actions -->
                <div class="flex items-center space-x-4 flex-shrink-0">
                    <!-- Progress Summary -->
                    <div class="hidden md:flex items-center space-x-2 bg-gray-50 dark:bg-gray-700 px-3 py-2 rounded-lg">
                        <div class="text-xs">
                            <div class="font-medium dark:text-white">Today's Progress</div>
                            <div class="flex items-center space-x-2">
                                <div class="w-24 progress-bar">
                                    <div id="dailyProgressFill" class="progress-fill bg-green-500" style="width: 0%"></div>
                                </div>
                                <span id="dailyProgressText" class="text-xs font-bold">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Header User Profile -->
                    <div class="flex items-center space-x-4">
                        <div class="hidden md:flex items-center space-x-2">
                            <div id="headerProfileImage" class="profile-img"></div>
                            <div class="hidden md:block">
                                <p id="headerUserName" class="text-sm font-medium truncate dark:text-white"></p>
                                <p id="headerUserRole" class="text-xs text-gray-500 dark:text-gray-400 truncate"></p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openAdd()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center space-x-2">
                                <i class="fas fa-plus"></i>
                                <span class="hidden md:inline">Add Task</span>
                            </button>
                            <button onclick="openQuickAdd()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 md:hidden">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <main class="p-4 space-y-4 min-w-0">
                <!-- Pending Tasks Summary -->
                <div id="pendingSummary" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow min-w-0 border dark:border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-lg flex items-center space-x-2 dark:text-white">
                            <i class="fas fa-clipboard-list text-blue-600 dark:text-blue-400"></i>
                            <span>Pending Tasks</span>
                        </h3>
                        <div class="flex items-center gap-2">
                            <span id="pendingCount" class="bg-yellow-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
                            <span id="urgentCount" class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
                            <span id="refreshStatus" class="text-xs text-gray-500 dark:text-gray-400 truncate"></span>
                            <button onclick="loadTasks(true)" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div id="pendingTasksList" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>

                <!-- Dashboard Stats -->
                <div id="dashboardStats" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <!-- Stats will be populated by JavaScript -->
                </div>

                <!-- Page Content -->
                <div id="pageContent">
                    <!-- Desktop Table (Default View) -->
                    <div id="tableView" class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-x-auto min-w-0 border dark:border-gray-700">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 dark:bg-gray-700 text-xs uppercase">
                                <tr>
                                    <th class="p-3">Task ID</th>
                                    <th class="p-3">Task</th>
                                    <th class="p-3">Priority</th>
                                    <th class="p-3">Assigned By</th>
                                    <th class="p-3">Assigned To</th>
                                    <th class="p-3">Due Date</th>
                                    <th class="p-3">Progress</th>
                                    <th class="p-3">Status</th>
                                    <th class="p-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="taskTable"></tbody>
                        </table>
                    </div>

                    <!-- Mobile Cards -->
                    <div id="mobileTasks" class="md:hidden space-y-4"></div>

                    <!-- Kanban Board -->
                    <div id="kanbanView" class="hidden">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="kanban-column">
                                <h3 class="font-semibold mb-4 flex items-center justify-between dark:text-white">
                                    <span class="flex items-center">
                                        <span class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></span>
                                        To Do
                                    </span>
                                    <span id="todoCount" class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs px-2 py-1 rounded">0</span>
                                </h3>
                                <div id="kanbanTodo" class="space-y-3" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                            </div>
                            <div class="kanban-column">
                                <h3 class="font-semibold mb-4 flex items-center justify-between dark:text-white">
                                    <span class="flex items-center">
                                        <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                                        In Progress
                                    </span>
                                    <span id="progressCount" class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs px-2 py-1 rounded">0</span>
                                </h3>
                                <div id="kanbanProgress" class="space-y-3" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                            </div>
                            <div class="kanban-column">
                                <h3 class="font-semibold mb-4 flex items-center justify-between dark:text-white">
                                    <span class="flex items-center">
                                        <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                                        Done
                                    </span>
                                    <span id="doneCount" class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs px-2 py-1 rounded">0</span>
                                </h3>
                                <div id="kanbanDone" class="space-y-3" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics View -->
                    <div id="analyticsView" class="hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border dark:border-gray-700">
                                <h3 class="font-semibold mb-4 dark:text-white">Tasks by Status</h3>
                                <canvas id="statusChart"></canvas>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border dark:border-gray-700">
                                <h3 class="font-semibold mb-4 dark:text-white">Tasks by Priority</h3>
                                <canvas id="priorityChart"></canvas>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border dark:border-gray-700">
                                <h3 class="font-semibold mb-4 dark:text-white">Completion Rate</h3>
                                <canvas id="completionChart"></canvas>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border dark:border-gray-700">
                                <h3 class="font-semibold mb-4 dark:text-white">Tasks by User</h3>
                                <canvas id="userChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Manage Users Table (Admin Only) -->
                    <div id="usersTableContainer" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold flex items-center space-x-2 dark:text-white">
                                <i class="fas fa-users"></i>
                                <span>Manage Users</span>
                            </h3>
                            <button onclick="openAddUser()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center space-x-2">
                                <i class="fas fa-plus"></i>
                                <span>Add User</span>
                            </button>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-x-auto border dark:border-gray-700">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 dark:bg-gray-700 text-xs uppercase">
                                    <tr>
                                        <th class="p-3">Username</th>
                                        <th class="p-3">Full Name</th>
                                        <th class="p-3">Email</th>
                                        <th class="p-3">Role</th>
                                        <th class="p-3">Status</th>
                                        <th class="p-3">Created At</th>
                                        <th class="p-3">Last Login</th>
                                        <th class="p-3">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTable"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Deleted Tasks Table (Admin Only) -->
                    <div id="deletedTasksContainer" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold flex items-center space-x-2 dark:text-white">
                                <i class="fas fa-trash"></i>
                                <span>Deleted Tasks</span>
                            </h3>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-x-auto border dark:border-gray-700">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 dark:bg-gray-700 text-xs uppercase">
                                    <tr>
                                        <th class="p-3">Task ID</th>
                                        <th class="p-3">Task</th>
                                        <th class="p-3">Assigned By</th>
                                        <th class="p-3">Assigned To</th>
                                        <th class="p-3">Deleted At</th>
                                        <th class="p-3">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="deletedTasksTable"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Reports View -->
                    <div id="reportsView" class="hidden">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow border dark:border-gray-700">
                            <h3 class="text-lg font-semibold mb-4 dark:text-white">Generate Reports</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div>
                                    <label class="block text-sm font-medium mb-1 dark:text-gray-300">Start Date</label>
                                    <input type="date" id="reportStartDate" class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded px-3 py-2">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1 dark:text-gray-300">End Date</label>
                                    <input type="date" id="reportEndDate" class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded px-3 py-2">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1 dark:text-gray-300">Report Type</label>
                                    <select id="reportType" class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded px-3 py-2">
                                        <option value="summary">Summary Report</option>
                                        <option value="detailed">Detailed Report</option>
                                        <option value="user">User Performance</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="generateReport()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                                    Generate Report
                                </button>
                                <button onclick="exportReport()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
                                    Export to Excel
                                </button>
                            </div>
                            <div id="reportOutput" class="mt-6 hidden">
                                <!-- Report will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- All Modals -->
    <!-- Add/Edit Task Modal -->
    <div id="taskModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50 p-4">
        <form id="taskForm" class="bg-white dark:bg-gray-800 w-full max-w-2xl p-6 rounded-lg space-y-4 max-h-[90vh] overflow-y-auto border dark:border-gray-700" onsubmit="saveTask(event)">
            <h3 id="modalTitle" class="font-semibold text-lg dark:text-white">Add New Task</h3>
            
            <input type="hidden" id="editId">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Task Title *</label>
                    <input id="taskTitle" required placeholder="Enter task description" 
                           class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Priority *</label>
                    <select id="taskPriority" required 
                            class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <option value="Urgent">Urgent</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Assigned By</label>
                    <select id="assignedBy" 
                            class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select or type...</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Assign To *</label>
                    <select id="assignedTo" required 
                            class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select team member</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Due Date</label>
                    <input type="date" id="dueDate" 
                           class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Progress (%)</label>
                    <div class="flex items-center space-x-3">
                        <input type="range" id="progress" min="0" max="100" value="0" 
                               class="flex-1"
                               oninput="document.getElementById('progressValue').textContent = this.value + '%'">
                        <span id="progressValue" class="text-sm font-medium w-12">0%</span>
                    </div>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</label>
                <textarea id="notes" placeholder="Add any additional notes..." 
                          class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3"></textarea>
            </div>
            
            <!-- Recurring Task Options -->
            <div id="recurringOptions" class="hidden">
                <div class="border-t dark:border-gray-700 pt-4">
                    <h4 class="font-medium mb-2 dark:text-white">Recurring Task Options</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Repeat</label>
                            <select id="recurringFrequency" 
                                    class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-4 py-2">
                                <option value="">Don't repeat</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Repeat Until</label>
                            <input type="date" id="recurringEndDate" 
                                   class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-4 py-2">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between items-center pt-4 border-t dark:border-gray-700">
                <button type="button" onclick="toggleRecurring()" class="text-sm text-blue-600 dark:text-blue-400 hover:underline">
                    <i class="fas fa-redo mr-1"></i> Make Recurring
                </button>
                <div class="flex gap-3">
                    <button type="button" onclick="closeModal()" 
                            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition dark:text-white">Cancel</button>
                    <button type="submit" id="saveBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center">
                        <span id="saveBtnText">Save Task</span>
                        <span id="saveLoading" class="hidden loading ml-2"></span>
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Quick Add Modal -->
    <div id="quickAddModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50 p-4">
        <form id="quickAddForm" class="bg-white dark:bg-gray-800 w-full max-w-md p-6 rounded-lg space-y-4 border dark:border-gray-700" onsubmit="quickSaveTask(event)">
            <h3 class="font-semibold text-lg dark:text-white">Quick Add Task</h3>
            <input type="text" id="quickTaskTitle" required placeholder="Task description" 
                   class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-4 py-3">
            <div class="flex gap-2">
                <select id="quickPriority" class="flex-1 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2">
                    <option value="Medium">Medium</option>
                    <option value="High">High</option>
                </select>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    Add
                </button>
            </div>
        </form>
    </div>

    <!-- Other Modals (same structure but with dark mode classes) -->
    <!-- ... (User Modal, Change Password Modal, Handover Modal, History Modal, Done Modal) ... -->

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://phcfczuzlhesehicknun.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBoY2ZjenV6bGhlc2VoaWNrbnVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNDI5NzcsImV4cCI6MjA4MzYxODk3N30.GpFaSC97-297lsUtiUKsWlK4EHGUz_Vzqlphmr3qQ5k';
        
        // Initialize Supabase client
        let supabaseClient;
        try {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('✅ Supabase client initialized successfully');
        } catch (error) {
            console.error('❌ Error initializing Supabase:', error);
        }
        
        // Global variables
        let tasks = [];
        let deletedTasks = [];
        let users = [];
        let currentUser = null;
        let currentUserRole = null;
        let currentUserId = null;
        let currentUserFullName = null;
        let currentTaskId = null;
        let currentHandoverId = null;
        let currentDoneId = null;
        let searchTerm = '';
        let activeFilters = {};
        let charts = {};
        let deferredPrompt = null;
        
        // Database tables structure for new features:
        /*
        // Tasks table should have these additional columns:
        - priority: text (Urgent, High, Medium, Low)
        - due_date: timestamp
        - progress: integer (0-100)
        - recurring_frequency: text (daily, weekly, monthly, null)
        - recurring_end_date: timestamp
        - parent_task_id: uuid (for recurring tasks chain)
        */
        
        // Cache system
        const cache = {
            users: { data: null, timestamp: null, ttl: 5 * 60 * 1000 },
            tasks: { data: null, timestamp: null, ttl: 30 * 1000 },
            deletedTasks: { data: null, timestamp: null, ttl: 60 * 1000 }
        };
        
        // Initialize PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            setTimeout(() => {
                if (currentUser && !localStorage.getItem('pwaDismissed')) {
                    document.getElementById('pwaInstallPrompt').classList.remove('hidden');
                }
            }, 3000);
        });
        
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA installed');
                    }
                    deferredPrompt = null;
                    document.getElementById('pwaInstallPrompt').classList.add('hidden');
                });
            }
        }
        
        function dismissPWA() {
            document.getElementById('pwaInstallPrompt').classList.add('hidden');
            localStorage.setItem('pwaDismissed', 'true');
        }
        
        // Dark Mode Functions
        function toggleDarkMode() {
            const html = document.documentElement;
            const icon = document.getElementById('darkModeIcon');
            
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
                localStorage.setItem('darkMode', 'false');
            } else {
                html.classList.add('dark');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                localStorage.setItem('darkMode', 'true');
            }
        }
        
        function loadDarkModePreference() {
            const darkMode = localStorage.getItem('darkMode');
            const html = document.documentElement;
            const icon = document.getElementById('darkModeIcon');
            
            if (darkMode === 'true') {
                html.classList.add('dark');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                html.classList.remove('dark');
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        }
        
        // Search and Filter Functions
        function handleGlobalSearch(event) {
            searchTerm = event.target.value.toLowerCase();
            applyFilters();
        }
        
        function clearSearch() {
            document.getElementById('globalSearch').value = '';
            searchTerm = '';
            applyFilters();
        }
        
        function applyFilters() {
            activeFilters = {
                priority: document.getElementById('filterPriority').value,
                status: document.getElementById('filterStatus').value,
                date: document.getElementById('filterDate').value
            };
            
            render();
        }
        
        function filterTasks(taskList) {
            return taskList.filter(task => {
                // Search filter
                if (searchTerm) {
                    const searchMatch = task.title.toLowerCase().includes(searchTerm) ||
                                      task.task_id.toLowerCase().includes(searchTerm) ||
                                      (task.note && task.note.toLowerCase().includes(searchTerm));
                    if (!searchMatch) return false;
                }
                
                // Priority filter
                if (activeFilters.priority && task.priority !== activeFilters.priority) {
                    return false;
                }
                
                // Status filter
                if (activeFilters.status && task.status !== activeFilters.status) {
                    return false;
                }
                
                // Date filter
                if (activeFilters.date && task.due_date) {
                    const taskDate = new Date(task.due_date).toISOString().split('T')[0];
                    if (taskDate !== activeFilters.date) return false;
                }
                
                return true;
            });
        }
        
        // Task Priority System
        function getPriorityColor(priority) {
            switch(priority) {
                case 'Urgent': return 'priority-urgent';
                case 'High': return 'priority-high';
                case 'Medium': return 'priority-medium';
                case 'Low': return 'priority-low';
                default: return 'priority-medium';
            }
        }
        
        function getPriorityIcon(priority) {
            switch(priority) {
                case 'Urgent': return 'fas fa-fire';
                case 'High': return 'fas fa-exclamation-triangle';
                case 'Medium': return 'fas fa-exclamation-circle';
                case 'Low': return 'fas fa-arrow-down';
                default: return 'fas fa-circle';
            }
        }
        
        // Progress Tracking
        function updateProgress(taskId, progress) {
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            tasks[taskIndex].progress = parseInt(progress);
            if (progress >= 100 && tasks[taskIndex].status !== 'Done') {
                tasks[taskIndex].status = 'Done';
                tasks[taskIndex].doneAt = new Date().toLocaleString();
                tasks[taskIndex].doneBy = currentUser;
            } else if (progress > 0 && progress < 100 && tasks[taskIndex].status !== 'In Progress') {
                tasks[taskIndex].status = 'In Progress';
            }
            
            // Save to database
            saveTaskProgress(taskId, progress);
            render();
        }
        
        async function saveTaskProgress(taskId, progress) {
            try {
                await supabaseClient
                    .from('tasks')
                    .update({ 
                        progress: progress,
                        status: progress >= 100 ? 'Done' : (progress > 0 ? 'In Progress' : 'Pending'),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', taskId);
                
                clearCache('tasks');
            } catch (error) {
                console.error('Error saving progress:', error);
            }
        }
        
        // Recurring Tasks
        function toggleRecurring() {
            const options = document.getElementById('recurringOptions');
            options.classList.toggle('hidden');
        }
        
        async function generateRecurringTasks(parentTask) {
            const frequency = document.getElementById('recurringFrequency').value;
            const endDate = document.getElementById('recurringEndDate').value;
            
            if (!frequency) return;
            
            const recurringTasks = [];
            let currentDate = new Date(parentTask.assignedAt);
            const endDateTime = new Date(endDate);
            
            while (currentDate <= endDateTime) {
                const nextDate = new Date(currentDate);
                
                switch(frequency) {
                    case 'daily':
                        nextDate.setDate(nextDate.getDate() + 1);
                        break;
                    case 'weekly':
                        nextDate.setDate(nextDate.getDate() + 7);
                        break;
                    case 'monthly':
                        nextDate.setMonth(nextDate.getMonth() + 1);
                        break;
                }
                
                if (nextDate <= endDateTime) {
                    const recurringTask = {
                        ...parentTask,
                        id: '',
                        task_id: await generateTaskId(),
                        assignedAt: nextDate.toLocaleString(),
                        status: 'Pending',
                        progress: 0,
                        parent_task_id: parentTask.id,
                        history: [`${new Date().toLocaleString()}: Created as recurring task from ${parentTask.task_id}`]
                    };
                    
                    recurringTasks.push(recurringTask);
                }
                
                currentDate = nextDate;
            }
            
            // Save recurring tasks to database
            for (const task of recurringTasks) {
                await saveTaskToSupabase(task, false);
            }
        }
        
        // Analytics and Reports
        function generateAnalytics() {
            if (!tasks.length) return;
            
            // Tasks by Status
            const statusData = {
                Pending: tasks.filter(t => t.status === 'Pending').length,
                'In Progress': tasks.filter(t => t.status === 'In Progress').length,
                Done: tasks.filter(t => t.status === 'Done').length
            };
            
            // Tasks by Priority
            const priorityData = {
                Urgent: tasks.filter(t => t.priority === 'Urgent').length,
                High: tasks.filter(t => t.priority === 'High').length,
                Medium: tasks.filter(t => t.priority === 'Medium').length,
                Low: tasks.filter(t => t.priority === 'Low').length
            };
            
            // Completion Rate
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.status === 'Done').length;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            // Tasks by User
            const userTasks = {};
            users.forEach(user => {
                const userTaskCount = tasks.filter(t => t.to === user.username).length;
                if (userTaskCount > 0) {
                    userTasks[user.full_name || user.username] = userTaskCount;
                }
            });
            
            // Update charts
            updateChart('statusChart', Object.keys(statusData), Object.values(statusData), 'doughnut', ['#eab308', '#3b82f6', '#10b981']);
            updateChart('priorityChart', Object.keys(priorityData), Object.values(priorityData), 'bar', ['#ef4444', '#f97316', '#eab308', '#22c55e']);
            updateChart('completionChart', ['Completed', 'Remaining'], [completionRate, 100 - completionRate], 'pie', ['#10b981', '#6b7280']);
            updateChart('userChart', Object.keys(userTasks), Object.values(userTasks), 'bar', '#3b82f6');
            
            // Update dashboard stats
            updateDashboardStats();
        }
        
        function updateChart(canvasId, labels, data, type, backgroundColor) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }
            
            charts[canvasId] = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: Array.isArray(backgroundColor) ? backgroundColor : backgroundColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: document.documentElement.classList.contains('dark') ? '#f3f4f6' : '#374151'
                            }
                        }
                    }
                }
            });
        }
        
        function updateDashboardStats() {
            const statsContainer = document.getElementById('dashboardStats');
            const urgentTasks = tasks.filter(t => t.priority === 'Urgent' && t.status !== 'Done').length;
            const overdueTasks = tasks.filter(t => {
                if (!t.due_date || t.status === 'Done') return false;
                return new Date(t.due_date) < new Date();
            }).length;
            const inProgressTasks = tasks.filter(t => t.status === 'In Progress').length;
            const myTasks = tasks.filter(t => t.to === currentUser && t.status !== 'Done').length;
            
            statsContainer.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Urgent Tasks</p>
                            <p class="text-2xl font-bold dark:text-white">${urgentTasks}</p>
                        </div>
                        <div class="p-3 bg-red-100 dark:bg-red-900/30 rounded-lg">
                            <i class="fas fa-fire text-red-600 dark:text-red-400 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Overdue</p>
                            <p class="text-2xl font-bold dark:text-white">${overdueTasks}</p>
                        </div>
                        <div class="p-3 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg">
                            <i class="fas fa-clock text-yellow-600 dark:text-yellow-400 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">In Progress</p>
                            <p class="text-2xl font-bold dark:text-white">${inProgressTasks}</p>
                        </div>
                        <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-lg">
                            <i class="fas fa-spinner text-blue-600 dark:text-blue-400 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">My Tasks</p>
                            <p class="text-2xl font-bold dark:text-white">${myTasks}</p>
                        </div>
                        <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-lg">
                            <i class="fas fa-user-check text-green-600 dark:text-green-400 text-xl"></i>
                        </div>
                    </div>
                </div>
            `;
            
            // Update daily progress
            const myCompletedTasks = tasks.filter(t => 
                t.to === currentUser && 
                t.status === 'Done' && 
                t.doneAt && 
                new Date(t.doneAt).toDateString() === new Date().toDateString()
            ).length;
            
            const dailyProgress = myTasks > 0 ? Math.round((myCompletedTasks / myTasks) * 100) : 100;
            document.getElementById('dailyProgressFill').style.width = `${dailyProgress}%`;
            document.getElementById('dailyProgressText').textContent = `${dailyProgress}%`;
        }
        
        // Kanban Board Functions
        function renderKanbanBoard() {
            const todoTasks = tasks.filter(t => t.status === 'Pending' || t.status === '');
            const progressTasks = tasks.filter(t => t.status === 'In Progress');
            const doneTasks = tasks.filter(t => t.status === 'Done');
            
            document.getElementById('todoCount').textContent = todoTasks.length;
            document.getElementById('progressCount').textContent = progressTasks.length;
            document.getElementById('doneCount').textContent = doneTasks.length;
            
            renderKanbanColumn('kanbanTodo', todoTasks);
            renderKanbanColumn('kanbanProgress', progressTasks);
            renderKanbanColumn('kanbanDone', doneTasks);
        }
        
        function renderKanbanColumn(columnId, columnTasks) {
            const column = document.getElementById(columnId);
            const filteredTasks = filterTasks(columnTasks);
            
            column.innerHTML = filteredTasks.map(task => `
                <div class="kanban-task bg-white dark:bg-gray-800 p-3 rounded-lg shadow border dark:border-gray-700" 
                     draggable="true" 
                     ondragstart="drag(event)" 
                     data-task-id="${task.id}">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-mono font-bold">${task.task_id}</span>
                        <span class="text-xs px-2 py-1 rounded ${getPriorityColor(task.priority)}">
                            <i class="${getPriorityIcon(task.priority)} mr-1"></i>
                            ${task.priority}
                        </span>
                    </div>
                    <h4 class="font-medium text-sm mb-2 dark:text-white break-words">${task.title}</h4>
                    <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                        <span>${task.to}</span>
                        ${task.due_date ? `<span><i class="far fa-calendar mr-1"></i>${new Date(task.due_date).toLocaleDateString()}</span>` : ''}
                    </div>
                    ${task.progress > 0 ? `
                    <div class="mt-2">
                        <div class="progress-bar">
                            <div class="progress-fill bg-blue-500" style="width: ${task.progress}%"></div>
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1 text-right">${task.progress}%</div>
                    </div>` : ''}
                </div>
            `).join('');
        }
        
        function allowDrop(ev) {
            ev.preventDefault();
        }
        
        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.dataset.taskId);
        }
        
        async function drop(ev) {
            ev.preventDefault();
            const taskId = ev.dataTransfer.getData("text");
            const targetColumn = ev.target.closest('.kanban-column');
            
            if (!targetColumn || !taskId) return;
            
            let newStatus = 'Pending';
            if (targetColumn.id === 'kanbanProgress') newStatus = 'In Progress';
            if (targetColumn.id === 'kanbanDone') newStatus = 'Done';
            
            // Update task status
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            const task = tasks[taskIndex];
            const oldStatus = task.status;
            
            if (newStatus !== oldStatus) {
                task.status = newStatus;
                if (newStatus === 'Done') {
                    task.doneAt = new Date().toLocaleString();
                    task.doneBy = currentUser;
                    task.progress = 100;
                } else if (newStatus === 'In Progress' && task.progress === 0) {
                    task.progress = 10;
                }
                
                task.history.push(`${new Date().toLocaleString()}: Status changed from ${oldStatus} to ${newStatus} via Kanban board`);
                
                // Save to database
                await saveTaskToSupabase(task, true);
                
                // Update UI
                renderKanbanBoard();
                render();
            }
        }
        
        // Export Reports
        function generateReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const reportType = document.getElementById('reportType').value;
            
            let filteredTasks = tasks;
            
            if (startDate && endDate) {
                filteredTasks = tasks.filter(task => {
                    const taskDate = new Date(task.assignedAt);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    return taskDate >= start && taskDate <= end;
                });
            }
            
            let reportHTML = '';
            
            switch(reportType) {
                case 'summary':
                    reportHTML = generateSummaryReport(filteredTasks);
                    break;
                case 'detailed':
                    reportHTML = generateDetailedReport(filteredTasks);
                    break;
                case 'user':
                    reportHTML = generateUserReport(filteredTasks);
                    break;
            }
            
            document.getElementById('reportOutput').innerHTML = reportHTML;
            document.getElementById('reportOutput').classList.remove('hidden');
        }
        
        function generateSummaryReport(tasks) {
            const stats = {
                total: tasks.length,
                completed: tasks.filter(t => t.status === 'Done').length,
                inProgress: tasks.filter(t => t.status === 'In Progress').length,
                pending: tasks.filter(t => t.status === 'Pending').length,
                urgent: tasks.filter(t => t.priority === 'Urgent').length,
                overdue: tasks.filter(t => {
                    if (!t.due_date || t.status === 'Done') return false;
                    return new Date(t.due_date) < new Date();
                }).length
            };
            
            return `
                <h4 class="font-semibold mb-4 dark:text-white">Summary Report</h4>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                    ${Object.entries(stats).map(([key, value]) => `
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</div>
                            <div class="text-2xl font-bold dark:text-white">${value}</div>
                        </div>
                    `).join('')}
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400">
                    Generated on ${new Date().toLocaleString()}
                </div>
            `;
        }
        
        function exportReport() {
            const reportOutput = document.getElementById('reportOutput').innerText;
            const blob = new Blob([reportOutput], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `awch-report-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Enhanced Task Loading with new fields
        async function loadTasks(forceRefresh = false) {
            try {
                document.getElementById('refreshStatus').textContent = 'Loading...';
                
                if (!forceRefresh && getFromCache('tasks')) {
                    tasks = getFromCache('tasks');
                    document.getElementById('refreshStatus').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                    return;
                }
                
                if (!supabaseClient) throw new Error('Supabase client not initialized');
                
                const { data, error } = await supabaseClient
                    .from('tasks')
                    .select('*')
                    .is('deleted_at', null)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                tasks = data.map(task => ({
                    id: task.id,
                    task_id: task.task_id,
                    title: task.title,
                    by: task.assigned_by,
                    to: task.assigned_to,
                    note: task.notes,
                    assignedAt: new Date(task.assigned_at).toLocaleString(),
                    due_date: task.due_date,
                    priority: task.priority || 'Medium',
                    progress: task.progress || 0,
                    status: task.status || 'Pending',
                    doneAt: task.done_at ? new Date(task.done_at).toLocaleString() : '',
                    doneBy: task.done_by || '',
                    doneNote: task.done_note || '',
                    history: task.history || [],
                    recurring_frequency: task.recurring_frequency,
                    recurring_end_date: task.recurring_end_date,
                    parent_task_id: task.parent_task_id
                }));
                
                setToCache('tasks', tasks);
                document.getElementById('refreshStatus').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                
                // Check for overdue tasks
                checkOverdueTasks();
                
            } catch (error) {
                console.error('Error loading tasks:', error);
                document.getElementById('refreshStatus').textContent = 'Error loading tasks';
            }
        }
        
        function checkOverdueTasks() {
            const today = new Date();
            tasks.forEach(task => {
                if (task.due_date && task.status !== 'Done') {
                    const dueDate = new Date(task.due_date);
                    if (dueDate < today) {
                        // You can add notification logic here
                        console.log(`Task ${task.task_id} is overdue!`);
                    }
                }
            });
        }
        
        // Enhanced Task Saving with new fields
        async function saveTaskToSupabase(task, isUpdate = false) {
            try {
                const taskData = {
                    task_id: task.task_id,
                    title: task.title,
                    assigned_by: task.by,
                    assigned_to: task.to,
                    notes: task.note,
                    assigned_at: new Date(task.assignedAt).toISOString(),
                    due_date: task.due_date ? new Date(task.due_date).toISOString() : null,
                    priority: task.priority,
                    progress: task.progress,
                    status: task.status,
                    done_at: task.doneAt ? new Date(task.doneAt).toISOString() : null,
                    done_by: task.doneBy || null,
                    done_note: task.doneNote || null,
                    history: task.history,
                    recurring_frequency: task.recurring_frequency || null,
                    recurring_end_date: task.recurring_end_date ? new Date(task.recurring_end_date).toISOString() : null,
                    parent_task_id: task.parent_task_id || null
                };
                
                let result;
                if (isUpdate) {
                    result = await supabaseClient
                        .from('tasks')
                        .update(taskData)
                        .eq('id', task.id);
                } else {
                    result = await supabaseClient
                        .from('tasks')
                        .insert([taskData]);
                }
                
                const { error } = result;
                if (error) throw error;
                
                clearCache('tasks');
                return true;
            } catch (error) {
                console.error('Error saving task:', error);
                alert('Error saving task to database');
                return false;
            }
        }
        
        // Quick Add Task
        function openQuickAdd() {
            document.getElementById('quickTaskTitle').value = '';
            document.getElementById('quickAddModal').classList.replace('hidden', 'flex');
        }
        
        async function quickSaveTask(e) {
            e.preventDefault();
            const title = document.getElementById('quickTaskTitle').value;
            const priority = document.getElementById('quickPriority').value;
            
            if (!title.trim()) return;
            
            const task = {
                id: '',
                task_id: await generateTaskId(),
                title: title,
                by: currentUser,
                to: currentUser,
                note: '',
                assignedAt: new Date().toLocaleString(),
                priority: priority,
                progress: 0,
                status: 'Pending',
                history: [`${new Date().toLocaleString()}: Created by ${currentUser} via Quick Add`]
            };
            
            const success = await saveTaskToSupabase(task, false);
            if (success) {
                document.getElementById('quickAddModal').classList.replace('flex', 'hidden');
                await loadTasks(true);
                render();
            }
        }
        
        // Enhanced Render Function
        async function render() {
            await loadTasks();
            
            const pageTitle = document.getElementById('pageTitle').textContent;
            let filtered = filterTasks(tasks);
            
            // Page-specific filtering
            if (pageTitle === 'My Tasks') {
                filtered = filtered.filter(t => t.to === currentUser && t.status !== 'Done');
            } else if (pageTitle === 'Done by Me') {
                filtered = filtered.filter(t => t.status === 'Done' && t.doneBy === currentUser);
            }
            
            // Sort by priority and date
            filtered.sort((a, b) => {
                const priorityOrder = { 'Urgent': 0, 'High': 1, 'Medium': 2, 'Low': 3 };
                const priorityDiff = (priorityOrder[a.priority] || 2) - (priorityOrder[b.priority] || 2);
                if (priorityDiff !== 0) return priorityDiff;
                return new Date(b.assignedAt) - new Date(a.assignedAt);
            });
            
            // Update UI based on current view
            updatePendingSummary();
            updateDashboardStats();
            
            if (pageTitle === 'Kanban Board') {
                document.getElementById('tableView').classList.add('hidden');
                document.getElementById('mobileTasks').classList.add('hidden');
                document.getElementById('kanbanView').classList.remove('hidden');
                renderKanbanBoard();
            } else if (pageTitle === 'Analytics') {
                document.getElementById('tableView').classList.add('hidden');
                document.getElementById('mobileTasks').classList.add('hidden');
                document.getElementById('kanbanView').classList.add('hidden');
                document.getElementById('analyticsView').classList.remove('hidden');
                setTimeout(() => generateAnalytics(), 100); // Wait for DOM
            } else if (pageTitle === 'Reports') {
                document.getElementById('tableView').classList.add('hidden');
                document.getElementById('mobileTasks').classList.add('hidden');
                document.getElementById('analyticsView').classList.add('hidden');
                document.getElementById('reportsView').classList.remove('hidden');
            } else if (pageTitle === 'Manage Users' || pageTitle === 'Deleted Tasks') {
                // Already handled by setPage
            } else {
                document.getElementById('tableView').classList.remove('hidden');
                document.getElementById('kanbanView').classList.add('hidden');
                document.getElementById('analyticsView').classList.add('hidden');
                document.getElementById('reportsView').classList.add('hidden');
                renderTable(filtered);
                renderMobileCards(filtered);
            }
            
            // Highlight search results
            if (searchTerm) {
                highlightSearchResults();
            }
        }
        
        function highlightSearchResults() {
            document.querySelectorAll('#taskTable td, #mobileTasks .kanban-task').forEach(element => {
                const html = element.innerHTML;
                const highlighted = html.replace(
                    new RegExp(searchTerm, 'gi'),
                    match => `<span class="search-highlight">${match}</span>`
                );
                if (highlighted !== html) {
                    element.innerHTML = highlighted;
                }
            });
        }
        
        // Enhanced Table Render
        function renderTable(filteredTasks) {
            const taskTable = document.getElementById('taskTable');
            
            taskTable.innerHTML = filteredTasks.map(task => {
                const isOverdue = task.due_date && new Date(task.due_date) < new Date() && task.status !== 'Done';
                
                return `
                <tr class="border-t dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition ${task.status === 'Pending' ? '' : 'bg-gray-50/50 dark:bg-gray-800/50'}">
                    <td class="p-3 font-mono text-xs font-bold whitespace-nowrap dark:text-white">${task.task_id}</td>
                    <td class="p-3 font-medium task-cell dark:text-white" style="min-width: 200px;">
                        ${task.title}
                        ${isOverdue ? '<span class="ml-2 text-xs bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 px-2 py-0.5 rounded">Overdue</span>' : ''}
                    </td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded-full text-xs ${getPriorityColor(task.priority)} whitespace-nowrap">
                            <i class="${getPriorityIcon(task.priority)} mr-1"></i>
                            ${task.priority}
                        </span>
                    </td>
                    <td class="p-3 task-cell dark:text-white">${task.by || '--'}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded-full text-xs ${task.to === currentUser ? 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'} whitespace-nowrap">
                            ${task.to}
                        </span>
                    </td>
                    <td class="p-3 text-xs ${isOverdue ? 'text-red-600 dark:text-red-400 font-bold' : 'text-gray-500 dark:text-gray-400'} whitespace-nowrap">
                        ${task.due_date ? new Date(task.due_date).toLocaleDateString() : '--'}
                    </td>
                    <td class="p-3">
                        <div class="space-y-1">
                            <div class="progress-bar">
                                <div class="progress-fill ${task.progress < 50 ? 'bg-red-500' : task.progress < 100 ? 'bg-yellow-500' : 'bg-green-500'}" 
                                     style="width: ${task.progress}%"></div>
                            </div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 text-center">${task.progress}%</div>
                        </div>
                    </td>
                    <td class="p-3">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium 
                                   ${task.status === 'Done' ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200' : 
                                     task.status === 'In Progress' ? 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200' : 
                                     'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200'} 
                                   whitespace-nowrap">
                            <span class="w-1.5 h-1.5 ${task.status === 'Done' ? 'bg-green-600' : 
                                                     task.status === 'In Progress' ? 'bg-blue-600' : 
                                                     'bg-yellow-600'} rounded-full mr-1.5"></span>
                            ${task.status}
                        </span>
                    </td>
                    <td class="p-3">
                        <div class="flex gap-1 flex-wrap">
                            <button onclick="updateProgress('${task.id}', ${Math.min(task.progress + 25, 100)})" 
                                    class="p-2 hover:bg-green-100 dark:hover:bg-green-900/30 rounded-lg transition" title="Add Progress">
                                <i class="fas fa-plus text-green-600 dark:text-green-400"></i>
                            </button>
                            <button onclick="openEdit('${task.id}')" 
                                    class="p-2 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg transition" title="Edit">
                                <i class="fas fa-edit text-blue-600 dark:text-blue-400"></i>
                            </button>
                            ${task.status !== 'Done' ? 
                                `<button onclick="openHandover('${task.id}')" 
                                        class="p-2 hover:bg-purple-100 dark:hover:bg-purple-900/30 rounded-lg transition" title="Handover">
                                    <i class="fas fa-exchange-alt text-purple-600 dark:text-purple-400"></i>
                                </button>` : ''
                            }
                            <button onclick="viewHistory('${task.id}')" 
                                    class="p-2 hover:bg-yellow-100 dark:hover:bg-yellow-900/30 rounded-lg transition" title="History">
                                <i class="fas fa-history text-yellow-600 dark:text-yellow-400"></i>
                            </button>
                            <button onclick="deleteTask('${task.id}')" 
                                    class="p-2 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg transition" title="Delete">
                                <i class="fas fa-trash text-red-600 dark:text-red-400"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
            
            if (filteredTasks.length === 0) {
                showEmptyState();
            }
        }
        
        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').then(registration => {
                    console.log('ServiceWorker registration successful');
                }).catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            // Load dark mode preference
            loadDarkModePreference();
            
            // Initialize date pickers
            flatpickr("#dueDate", {
                dateFormat: "Y-m-d",
                minDate: "today"
            });
            
            flatpickr("#recurringEndDate", {
                dateFormat: "Y-m-d",
                minDate: "today"
            });
            
            flatpickr("#filterDate", {
                dateFormat: "Y-m-d"
            });
            
            // Check auto-login
            const savedUser = localStorage.getItem('awch_user');
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    const isAutoLoggedIn = await checkAutoLogin(userData);
                    
                    if (isAutoLoggedIn) {
                        await initializeApp();
                    }
                } catch (error) {
                    localStorage.removeItem('awch_user');
                }
            }
            
            // Set up auto-refresh
            setInterval(async () => {
                if (currentUser) {
                    await loadTasks();
                    render();
                }
            }, 30000);
        });
        
        // Export useful functions to window
        window.clearAppCache = clearCache;
        window.forceRefresh = async () => {
            clearCache();
            await loadUsers(true);
            await loadTasks(true);
            render();
            alert('Data refreshed from database');
        };
        
        // Note: You need to add the missing functions from your original code:
        // - handleLogin, logout, saveTask, openEdit, closeModal, etc.
        // - Cache helper functions (getFromCache, setToCache, clearCache)
        // - Password hashing functions
        // - All other existing functions from your original code
        
        // Add these at the end or integrate with your existing functions
    </script>
</body>
</html>
