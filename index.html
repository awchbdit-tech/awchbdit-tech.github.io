<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWCH IT Work Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Custom styles */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Prevent word break in task cells */
        .task-cell {
            word-wrap: break-word;
            white-space: normal;
            max-width: 250px;
            min-width: 150px;
        }
        
        /* Mobile menu overlay */
        .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 30;
        }
        
        /* Profile image styles */
        .profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #4b5563;
        }
        
        /* Web view optimization */
        html, body {
            width: 100%;
            overflow-x: hidden;
        }
        
        #appContainer {
            min-width: 320px;
        }
        
        @media (max-width: 768px) {
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <h1 class="text-2xl font-bold text-blue-600 text-center mb-2">AWCH IT Work Tracker</h1>
            <p class="text-gray-600 text-center mb-6">Track and manage your tasks efficiently</p>
            
            <form id="loginForm" onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="loginUsername" required 
                           class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Enter your username">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="loginPassword" required 
                           class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Enter your password">
                </div>
                
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition flex items-center justify-center">
                    <span id="loginBtnText">Login to Dashboard</span>
                    <span id="loginLoading" class="hidden loading ml-2"></span>
                </button>
            </form>
        </div>
    </div>

    <!-- Main App (Initially Hidden) -->
    <div id="appContainer" class="hidden min-h-screen flex">
        <!-- Mobile Menu Overlay -->
        <div id="mobileMenuOverlay" class="mobile-menu-overlay hidden md:hidden" onclick="toggleMenu()"></div>
        
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed md:static z-40 inset-y-0 left-0 w-64 bg-white border-r transform -translate-x-full md:translate-x-0 transition">
            <div class="p-6">
                <h1 class="text-xl font-bold text-blue-600">AWCH IT Work Tracker</h1>
                
                <!-- User Profile in Sidebar -->
                <div class="mt-4 flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                    <div id="userProfileImage" class="profile-img">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p id="sidebarUserName" class="text-sm font-medium text-gray-900 truncate"></p>
                        <p id="sidebarUserRole" class="text-xs text-gray-500"></p>
                    </div>
                    <button onclick="toggleUserProfile()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                
                <!-- User Profile Dropdown -->
                <div id="userProfileDropdown" class="hidden mt-2 bg-white border rounded-lg shadow-lg p-4 space-y-3">
                    <div class="text-center">
                        <div id="dropdownProfileImage" class="profile-img mx-auto mb-2" style="width: 60px; height: 60px; font-size: 24px;">
                            <i class="fas fa-user"></i>
                        </div>
                        <h3 id="dropdownUserName" class="font-semibold"></h3>
                        <p id="dropdownUserRole" class="text-sm text-gray-500"></p>
                    </div>
                    
                    <div class="border-t pt-3 space-y-2">
                        <button onclick="openChangePassword()" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded flex items-center space-x-2">
                            <i class="fas fa-key w-4"></i>
                            <span>Change Password</span>
                        </button>
                        <button onclick="logout()" class="w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded flex items-center space-x-2">
                            <i class="fas fa-sign-out-alt w-4"></i>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
                
                <nav class="mt-6 space-y-2">
                    <button onclick="setPage('Dashboard')" class="menuBtn w-full text-left px-4 py-2 rounded bg-blue-600 text-white flex items-center space-x-2">
                        <i class="fas fa-tachometer-alt w-4"></i>
                        <span>Dashboard</span>
                    </button>
                    <button onclick="setPage('My Tasks')" class="menuBtn w-full text-left px-4 py-2 rounded hover:bg-gray-100 flex items-center space-x-2">
                        <i class="fas fa-tasks w-4"></i>
                        <span>My Tasks</span>
                    </button>
                    <button onclick="setPage('Done by Me')" class="menuBtn w-full text-left px-4 py-2 rounded hover:bg-gray-100 flex items-center space-x-2">
                        <i class="fas fa-check-circle w-4"></i>
                        <span>Done by Me</span>
                    </button>
                    
                    <!-- Admin Only Menu -->
                    <div id="adminMenu" class="hidden mt-4 pt-4 border-t">
                        <h3 class="text-xs font-semibold text-gray-500 uppercase mb-2">Admin Panel</h3>
                        <button onclick="setPage('Manage Users')" class="menuBtn w-full text-left px-4 py-2 rounded hover:bg-gray-100 flex items-center space-x-2">
                            <i class="fas fa-users w-4"></i>
                            <span>Manage Users</span>
                        </button>
                        <button onclick="setPage('Deleted Tasks')" class="menuBtn w-full text-left px-4 py-2 rounded hover:bg-gray-100 flex items-center space-x-2">
                            <i class="fas fa-trash w-4"></i>
                            <span>Deleted Tasks</span>
                        </button>
                    </div>
                </nav>
                
                <div class="mt-8 text-xs text-gray-500">
                    <p id="dbStatusText">Connecting to database...</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col min-w-0">
            <header class="bg-white border-b px-4 py-3 flex justify-between items-center min-w-0">
                <div class="flex items-center gap-3 min-w-0">
                    <button class="md:hidden" onclick="toggleMenu()">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <h2 id="pageTitle" class="font-semibold truncate">Dashboard</h2>
                </div>
                
                <!-- Header User Profile -->
                <div class="flex items-center space-x-4 flex-shrink-0">
                    <div class="hidden md:flex items-center space-x-2">
                        <div id="headerProfileImage" class="profile-img"></div>
                        <div class="hidden md:block">
                            <p id="headerUserName" class="text-sm font-medium truncate"></p>
                            <p id="headerUserRole" class="text-xs text-gray-500 truncate"></p>
                        </div>
                    </div>
                    <button onclick="openAdd()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center space-x-2">
                        <i class="fas fa-plus"></i>
                        <span class="hidden md:inline">Add Task</span>
                    </button>
                </div>
            </header>

            <main class="p-4 space-y-4 min-w-0">
                <!-- Pending Tasks Summary -->
                <div id="pendingSummary" class="bg-white p-4 rounded-lg shadow min-w-0">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-lg flex items-center space-x-2">
                            <i class="fas fa-clipboard-list text-blue-600"></i>
                            <span>Pending Tasks</span>
                        </h3>
                        <div class="flex items-center gap-2">
                            <span id="pendingCount" class="bg-yellow-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
                            <span id="refreshStatus" class="text-xs text-gray-500 truncate"></span>
                        </div>
                    </div>
                    <div id="pendingTasksList" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>

                <!-- Desktop Table -->
                <div class="hidden md:block bg-white rounded-lg shadow overflow-x-auto min-w-0">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-xs uppercase">
                            <tr>
                                <th class="p-3">Task ID</th>
                                <th class="p-3">Task</th>
                                <th class="p-3">Assigned By</th>
                                <th class="p-3">Assigned To</th>
                                <th class="p-3">Assigned</th>
                                <th class="p-3">Done At</th>
                                <th class="p-3">Status</th>
                                <th class="p-3">Notes</th>
                                <th class="p-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="taskTable"></tbody>
                    </table>
                </div>

                <!-- Mobile Cards -->
                <div id="mobileTasks" class="md:hidden space-y-4"></div>

                <!-- Manage Users Table (Admin Only) -->
                <div id="usersTableContainer" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold flex items-center space-x-2">
                            <i class="fas fa-users"></i>
                            <span>Manage Users</span>
                        </h3>
                        <button onclick="openAddUser()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center space-x-2">
                            <i class="fas fa-plus"></i>
                            <span>Add User</span>
                        </button>
                    </div>
                    <div class="bg-white rounded-lg shadow overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 text-xs uppercase">
                                <tr>
                                    <th class="p-3">Username</th>
                                    <th class="p-3">Full Name</th>
                                    <th class="p-3">Email</th>
                                    <th class="p-3">Role</th>
                                    <th class="p-3">Status</th>
                                    <th class="p-3">Created At</th>
                                    <th class="p-3">Last Login</th>
                                    <th class="p-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Deleted Tasks Table (Admin Only) -->
                <div id="deletedTasksContainer" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold flex items-center space-x-2">
                            <i class="fas fa-trash"></i>
                            <span>Deleted Tasks</span>
                        </h3>
                    </div>
                    <div class="bg-white rounded-lg shadow overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 text-xs uppercase">
                                <tr>
                                    <th class="p-3">Task ID</th>
                                    <th class="p-3">Task</th>
                                    <th class="p-3">Assigned By</th>
                                    <th class="p-3">Assigned To</th>
                                    <th class="p-3">Deleted At</th>
                                    <th class="p-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="deletedTasksTable"></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add/Edit Task Modal -->
    <div id="taskModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
        <form id="taskForm" class="bg-white w-full max-w-md p-6 rounded-lg space-y-4" onsubmit="saveTask(event)">
            <h3 id="modalTitle" class="font-semibold text-lg">Add New Task</h3>
            
            <input type="hidden" id="editId">
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Task Title *</label>
                <input id="taskTitle" required placeholder="Enter task description" 
                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Assigned By</label>
                <select id="assignedBy" 
                        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Select or type...</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Assign To *</label>
                <select id="assignedTo" required 
                        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Select team member</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Notes (Optional)</label>
                <textarea id="notes" placeholder="Add any additional notes..." 
                          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3"></textarea>
            </div>
            
            <div class="flex justify-end gap-3 pt-3">
                <button type="button" onclick="closeModal()" 
                        class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">Cancel</button>
                <button type="submit" id="saveBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center">
                    <span id="saveBtnText">Save Task</span>
                    <span id="saveLoading" class="hidden loading ml-2"></span>
                </button>
            </div>
        </form>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="userModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
        <form id="userForm" class="bg-white w-full max-w-md p-6 rounded-lg space-y-4" onsubmit="saveUser(event)">
            <h3 id="userModalTitle" class="font-semibold text-lg">Add New User</h3>
            
            <input type="hidden" id="editUserId">
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Username *</label>
                <input id="username" required placeholder="Enter username" 
                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                <input id="fullName" placeholder="Enter full name" 
                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input type="email" id="email" placeholder="Enter email" 
                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Role *</label>
                <select id="userRole" required 
                        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status *</label>
                <select id="userStatus" required 
                        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select>
            </div>
            
            <div id="passwordFields">
                <label class="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                <input type="password" id="password" required placeholder="Enter password" 
                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <p class="text-xs text-gray-500 mt-1">Password must be at least 6 characters</p>
            </div>
            
            <div class="flex justify-end gap-3 pt-3">
                <button type="button" onclick="closeUserModal()" 
                        class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">Cancel</button>
                <button type="submit" id="saveUserBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center">
                    <span id="saveUserBtnText">Save User</span>
                    <span id="saveUserLoading" class="hidden loading ml-2"></span>
                </button>
            </div>
        </form>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
        <form id="changePasswordForm" class="bg-white w-full max-w-md p-6 rounded-lg space-y-4" onsubmit="changePassword(event)">
            <h3 class="font-semibold text-lg flex items-center space-x-2">
                <i class="fas fa-key"></i>
                <span>Change Password</span>
            </h3>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Current Password *</label>
                <input type="password" id="currentPassword" required placeholder="Enter current password" 
                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">New Password *</label>
                <input type="password" id="newPassword" required placeholder="Enter new password" 
                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Confirm New Password *</label>
                <input type="password" id="confirmPassword" required placeholder="Confirm new password" 
                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <div class="flex justify-end gap-3 pt-3">
                <button type="button" onclick="closeChangePasswordModal()" 
                        class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">Cancel</button>
                <button type="submit" id="changePasswordBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center">
                    <span id="changePasswordBtnText">Change Password</span>
                    <span id="changePasswordLoading" class="hidden loading ml-2"></span>
                </button>
            </div>
        </form>
    </div>

    <!-- Other Modals (Handover, History, Done) -->
    <div id="handoverModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
        <div class="bg-white w-full max-w-md p-6 rounded-lg space-y-4">
            <h3 class="font-semibold text-lg flex items-center space-x-2">
                <i class="fas fa-exchange-alt"></i>
                <span>Handover Task</span>
            </h3>
            <p class="text-sm text-gray-600">Transfer this task to another team member</p>
            
            <select id="handoverTo" 
                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">Select team member</option>
            </select>
            
            <div class="flex justify-end gap-3 pt-2">
                <button onclick="closeHandover()" 
                        class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">Cancel</button>
                <button onclick="confirmHandover()" id="handoverBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center">
                    <span id="handoverBtnText">Confirm Handover</span>
                    <span id="handoverLoading" class="hidden loading ml-2"></span>
                </button>
            </div>
        </div>
    </div>

    <div id="historyModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
        <div class="bg-white w-full max-w-md p-6 rounded-lg space-y-4">
            <h3 class="font-semibold text-lg flex items-center space-x-2">
                <i class="fas fa-history"></i>
                <span>Task History</span>
            </h3>
            <div id="historyList" class="space-y-2 max-h-60 overflow-y-auto"></div>
            <button onclick="closeHistory()" 
                    class="w-full border border-gray-300 rounded-lg py-2 hover:bg-gray-50 transition">Close</button>
        </div>
    </div>

    <div id="doneModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
        <div class="bg-white w-full max-w-md p-6 rounded-lg space-y-4">
            <h3 class="font-semibold text-lg flex items-center space-x-2">
                <i class="fas fa-check-circle"></i>
                <span>Mark as Complete</span>
            </h3>
            <p class="text-sm text-gray-600">Add a completion note (optional)</p>
            <textarea id="doneNote" placeholder="What was accomplished? Any details..." 
                      class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
            <div class="flex justify-end gap-3 pt-2">
                <button onclick="closeDoneModal()" 
                        class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">Cancel</button>
                <button onclick="confirmMarkDone()" id="doneBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center">
                    <span id="doneBtnText">Mark Complete</span>
                    <span id="doneLoading" class="hidden loading ml-2"></span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://phcfczuzlhesehicknun.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBoY2ZjenV6bGhlc2VoaWNrbnVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNDI5NzcsImV4cCI6MjA4MzYxODk3N30.GpFaSC97-297lsUtiUKsWlK4EHGUz_Vzqlphmr3qQ5k';
        
        // Initialize Supabase client
        let supabaseClient;
        try {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('✅ Supabase client initialized successfully');
        } catch (error) {
            console.error('❌ Error initializing Supabase:', error);
        }
        
        // Global variables
        let tasks = [];
        let deletedTasks = [];
        let users = [];
        let currentUser = null;
        let currentUserRole = null;
        let currentUserId = null;
        let currentUserFullName = null;
        let currentTaskId = null;
        let currentHandoverId = null;
        let currentDoneId = null;
        
        // Data Caching System (FIXED)
        const cache = {
            users: { data: null, timestamp: null, ttl: 5 * 60 * 1000 }, // 5 minutes
            tasks: { data: null, timestamp: null, ttl: 30 * 1000 },     // 30 seconds
            deletedTasks: { data: null, timestamp: null, ttl: 60 * 1000 } // 1 minute
        };
        
        // Cache helper functions
        function getFromCache(key) {
            const item = cache[key];
            if (!item || !item.data || !item.timestamp) return null;
            
            const age = Date.now() - item.timestamp;
            if (age > item.ttl) {
                console.log(`Cache expired for ${key}, age: ${age}ms, ttl: ${item.ttl}ms`);
                cache[key] = { data: null, timestamp: null, ttl: item.ttl };
                return null;
            }
            
            console.log(`Cache hit for ${key}, age: ${age}ms`);
            return item.data;
        }
        
        function setToCache(key, data) {
            cache[key] = {
                data: data,
                timestamp: Date.now(),
                ttl: cache[key] ? cache[key].ttl : 5 * 60 * 1000
            };
            console.log(`Cache set for ${key}`);
        }
        
        function clearCache(key = null) {
            if (key) {
                cache[key] = { data: null, timestamp: null, ttl: cache[key]?.ttl || 5 * 60 * 1000 };
                console.log(`Cache cleared for ${key}`);
            } else {
                Object.keys(cache).forEach(k => {
                    cache[k] = { data: null, timestamp: null, ttl: cache[k]?.ttl || 5 * 60 * 1000 };
                });
                console.log('All caches cleared');
            }
        }
        
        // Password hashing function (FIXED - using SHA-256)
        async function hashPassword(password) {
            try {
                // Convert password to Uint8Array
                const encoder = new TextEncoder();
                const data = encoder.encode(password);
                
                // Hash the password using SHA-256
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                
                // Convert buffer to hex string
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                
                return hashHex;
            } catch (error) {
                console.error('Error hashing password:', error);
                // Fallback simple hash for compatibility
                return 'sha256_' + btoa(password).replace(/=/g, '');
            }
        }
        
        // Password verification function
        async function verifyPassword(inputPassword, storedHash) {
            if (!storedHash || !inputPassword) return false;
            
            // Check if it's the old dummy hash format
            if (storedHash.startsWith('$2a$10$')) {
                // This is a dummy hash from old system - for migration purposes
                // In production, you should migrate all passwords to new format
                console.warn('Using legacy password verification');
                return await hashPassword(inputPassword) === await hashPassword('123456');
            }
            
            // Normal verification with SHA-256
            const inputHash = await hashPassword(inputPassword);
            return inputHash === storedHash;
        }
        
        // Generate Task ID: YYYYMM + Serial Number (Monthly reset)
        async function generateTaskId() {
            const today = new Date();
            const monthStr = today.getFullYear() + String(today.getMonth() + 1).padStart(2, '0');
            
            // Try to get from cache first
            const cachedTasks = getFromCache('tasks');
            if (cachedTasks) {
                const thisMonthTasks = cachedTasks.filter(task => 
                    task.task_id && task.task_id.startsWith(monthStr)
                );
                
                if (thisMonthTasks.length > 0) {
                    const maxSerial = Math.max(...thisMonthTasks.map(task => {
                        const serial = parseInt(task.task_id.substring(6)) || 0;
                        return serial;
                    }));
                    const nextSerial = String(maxSerial + 1).padStart(3, '0');
                    return `${monthStr}${nextSerial}`;
                }
                return `${monthStr}001`;
            }
            
            // Fallback to database query
            try {
                const { data, error } = await supabaseClient
                    .from('tasks')
                    .select('task_id')
                    .like('task_id', `${monthStr}%`)
                    .is('deleted_at', null);
                
                if (error) throw error;
                
                let maxSerial = 0;
                data.forEach(task => {
                    const serial = parseInt(task.task_id.substring(6)) || 0;
                    if (serial > maxSerial) maxSerial = serial;
                });
                
                const nextSerial = String(maxSerial + 1).padStart(3, '0');
                return `${monthStr}${nextSerial}`;
            } catch (error) {
                console.error('Error generating task ID:', error);
                // Fallback: timestamp based ID
                return `T-${Date.now()}`;
            }
        }
        
        // Database connection test
        async function testDatabaseConnection() {
            try {
                if (!supabaseClient) {
                    throw new Error('Supabase client not initialized');
                }
                
                const { data, error } = await supabaseClient
                    .from('tasks')
                    .select('count')
                    .limit(1)
                    .is('deleted_at', null);
                
                if (error) throw error;
                
                document.getElementById('dbStatusText').innerHTML = 
                    `<span class="text-green-600">✓ Connected to database</span>`;
                console.log('✅ Database connection successful');
                return true;
            } catch (error) {
                console.error('❌ Database connection failed:', error);
                document.getElementById('dbStatusText').innerHTML = 
                    `<span class="text-red-600">✗ Connection failed</span>`;
                return false;
            }
        }
        
        // Login Functions (FIXED with proper password verification)
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                alert('Please enter username and password');
                return;
            }
            
            // Show loading
            document.getElementById('loginBtnText').textContent = 'Authenticating...';
            document.getElementById('loginLoading').classList.remove('hidden');
            
            try {
                // Get user from database
                const { data: userData, error: userError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .single();
                
                if (userError || !userData) {
                    throw new Error('Invalid username or password');
                }
                
                // Check if user is active
                if (!userData.is_active) {
                    alert('User account is inactive. Please contact administrator.');
                    document.getElementById('loginBtnText').textContent = 'Login to Dashboard';
                    document.getElementById('loginLoading').classList.add('hidden');
                    return;
                }
                
                // Password verification (FIXED - using hash verification)
                const isPasswordValid = await verifyPassword(password, userData.password_hash);
                
                if (!isPasswordValid) {
                    alert('Invalid password!');
                    document.getElementById('loginBtnText').textContent = 'Login to Dashboard';
                    document.getElementById('loginLoading').classList.add('hidden');
                    return;
                }
                
                // Update last login time
                await supabaseClient
                    .from('users')
                    .update({ last_login_at: new Date().toISOString() })
                    .eq('id', userData.id);
                
                // Set current user
                currentUser = userData.username;
                currentUserRole = userData.role;
                currentUserId = userData.id;
                currentUserFullName = userData.full_name || userData.username;
                
                // Update UI with user info
                updateUserProfileUI(userData);
                
                // Show admin menu if user is admin
                if (userData.role === 'admin') {
                    document.getElementById('adminMenu').classList.remove('hidden');
                }
                
                // Test database connection
                const dbConnected = await testDatabaseConnection();
                
                if (!dbConnected) {
                    alert('Cannot connect to database. Please check your connection.');
                    document.getElementById('loginBtnText').textContent = 'Login to Dashboard';
                    document.getElementById('loginLoading').classList.add('hidden');
                    return;
                }
                
                // Clear cache for fresh data
                clearCache();
                
                // Load users and tasks
                await loadUsers();
                await loadTasks();
                
                // Show app, hide login
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                
                // Initial render
                render();
                
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please check username and password.');
            }
            
            // Reset button
            document.getElementById('loginBtnText').textContent = 'Login to Dashboard';
            document.getElementById('loginLoading').classList.add('hidden');
        }
        
        // Update user profile UI
        function updateUserProfileUI(user) {
            const displayName = user.full_name || user.username;
            const initials = getInitials(displayName);
            
            // Update all profile displays
            document.getElementById('sidebarUserName').textContent = displayName;
            document.getElementById('sidebarUserRole').textContent = user.role;
            document.getElementById('dropdownUserName').textContent = displayName;
            document.getElementById('dropdownUserRole').textContent = user.role;
            document.getElementById('headerUserName').textContent = displayName;
            document.getElementById('headerUserRole').textContent = user.role;
            
            // Update profile images with initials
            document.getElementById('userProfileImage').innerHTML = initials;
            document.getElementById('dropdownProfileImage').innerHTML = initials;
            document.getElementById('headerProfileImage').innerHTML = initials;
            
            // Set background color based on username
            const colors = ['bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-red-500', 'bg-yellow-500', 'bg-pink-500'];
            const colorIndex = user.username.length % colors.length;
            const textColor = 'text-white';
            
            document.getElementById('userProfileImage').className = `profile-img ${colors[colorIndex]} ${textColor}`;
            document.getElementById('dropdownProfileImage').className = `profile-img mx-auto mb-2 ${colors[colorIndex]} ${textColor}`;
            document.getElementById('headerProfileImage').className = `profile-img ${colors[colorIndex]} ${textColor}`;
        }
        
        // Get initials from name
        function getInitials(name) {
            return name.split(' ')
                .map(word => word.charAt(0))
                .join('')
                .toUpperCase()
                .substring(0, 2);
        }
        
        // Toggle user profile dropdown
        function toggleUserProfile() {
            const dropdown = document.getElementById('userProfileDropdown');
            dropdown.classList.toggle('hidden');
        }
        
        // Load users from Supabase (with caching)
        async function loadUsers(forceRefresh = false) {
            try {
                // Check cache first
                if (!forceRefresh) {
                    const cachedUsers = getFromCache('users');
                    if (cachedUsers) {
                        users = cachedUsers;
                        console.log('Loaded users from cache:', users.length);
                        populateUserDropdowns();
                        return;
                    }
                }
                
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .order('username', { ascending: true });
                
                if (error) throw error;
                
                users = data;
                console.log('Loaded users from database:', users.length);
                
                // Cache the users data
                setToCache('users', users);
                
                // Populate user dropdowns
                populateUserDropdowns();
                
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Error loading users from database');
            }
        }
        
        // Populate user dropdowns
        function populateUserDropdowns() {
            const assignedBySelect = document.getElementById('assignedBy');
            const assignedToSelect = document.getElementById('assignedTo');
            const handoverToSelect = document.getElementById('handoverTo');
            
            // Clear existing options except the first one
            [assignedBySelect, assignedToSelect, handoverToSelect].forEach(select => {
                while (select.options.length > 1) {
                    select.remove(1);
                }
            });
            
            // Add user options (active users only for assignment)
            users
                .filter(user => user.is_active)
                .forEach(user => {
                const displayName = user.full_name || user.username;
                
                // Add to assignedBy
                const option1 = document.createElement('option');
                option1.value = user.username;
                option1.textContent = `${displayName} (${user.role})`;
                assignedBySelect.appendChild(option1);
                
                // Add to assignedTo
                const option2 = document.createElement('option');
                option2.value = user.username;
                option2.textContent = `${displayName} (${user.role})`;
                assignedToSelect.appendChild(option2);
                
                // Add to handoverTo
                const option3 = document.createElement('option');
                option3.value = user.username;
                option3.textContent = `${displayName} (${user.role})`;
                handoverToSelect.appendChild(option3);
            });
        }
        
        // Load tasks from Supabase (with caching)
        async function loadTasks(forceRefresh = false) {
            try {
                document.getElementById('refreshStatus').textContent = 'Loading...';
                
                // Check cache first
                if (!forceRefresh) {
                    const cachedTasks = getFromCache('tasks');
                    if (cachedTasks) {
                        tasks = cachedTasks;
                        console.log('Loaded tasks from cache:', tasks.length);
                        document.getElementById('refreshStatus').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                        return;
                    }
                }
                
                if (!supabaseClient) {
                    throw new Error('Supabase client not initialized');
                }
                
                const { data, error } = await supabaseClient
                    .from('tasks')
                    .select('*')
                    .is('deleted_at', null)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                tasks = data.map(task => ({
                    id: task.id,
                    task_id: task.task_id,
                    title: task.title,
                    by: task.assigned_by,
                    to: task.assigned_to,
                    note: task.notes,
                    assignedAt: new Date(task.assigned_at).toLocaleString(),
                    doneAt: task.done_at ? new Date(task.done_at).toLocaleString() : '',
                    doneBy: task.done_by || '',
                    doneNote: task.done_note || '',
                    status: task.status,
                    history: task.history || []
                }));
                
                // Cache the tasks data
                setToCache('tasks', tasks);
                
                document.getElementById('refreshStatus').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                
            } catch (error) {
                console.error('Error loading tasks:', error);
                document.getElementById('refreshStatus').textContent = 'Error loading tasks';
                alert('Error loading tasks from database');
            }
        }
        
        // Load deleted tasks (Admin only, with caching)
        async function loadDeletedTasks(forceRefresh = false) {
            try {
                // Check cache first
                if (!forceRefresh) {
                    const cachedDeletedTasks = getFromCache('deletedTasks');
                    if (cachedDeletedTasks) {
                        deletedTasks = cachedDeletedTasks;
                        console.log('Loaded deleted tasks from cache:', deletedTasks.length);
                        renderDeletedTasks();
                        return;
                    }
                }
                
                const { data, error } = await supabaseClient
                    .from('tasks')
                    .select('*')
                    .not('deleted_at', 'is', null)
                    .order('deleted_at', { ascending: false });
                
                if (error) throw error;
                
                deletedTasks = data.map(task => ({
                    id: task.id,
                    task_id: task.task_id,
                    title: task.title,
                    by: task.assigned_by,
                    to: task.assigned_to,
                    deletedAt: new Date(task.deleted_at).toLocaleString(),
                    history: task.history || []
                }));
                
                // Cache the deleted tasks data
                setToCache('deletedTasks', deletedTasks);
                
                renderDeletedTasks();
                
            } catch (error) {
                console.error('Error loading deleted tasks:', error);
                alert('Error loading deleted tasks');
            }
        }
        
        // Save task to Supabase (and update cache)
        async function saveTaskToSupabase(task, isUpdate = false) {
            try {
                if (!supabaseClient) {
                    throw new Error('Supabase client not initialized');
                }
                
                const taskData = {
                    task_id: task.task_id,
                    title: task.title,
                    assigned_by: task.by,
                    assigned_to: task.to,
                    notes: task.note,
                    assigned_at: new Date(task.assignedAt).toISOString(),
                    done_at: task.doneAt ? new Date(task.doneAt).toISOString() : null,
                    done_by: task.doneBy || null,
                    done_note: task.doneNote || null,
                    status: task.status,
                    history: task.history
                };
                
                let result;
                if (isUpdate) {
                    result = await supabaseClient
                        .from('tasks')
                        .update(taskData)
                        .eq('id', task.id);
                } else {
                    result = await supabaseClient
                        .from('tasks')
                        .insert([taskData]);
                }
                
                const { error } = result;
                if (error) throw error;
                
                // Invalidate tasks cache
                clearCache('tasks');
                
                return true;
            } catch (error) {
                console.error('Error saving task:', error);
                alert('Error saving task to database');
                return false;
            }
        }
        
        // Soft delete task (mark as deleted)
        async function softDeleteTask(taskId) {
            try {
                if (!supabaseClient) {
                    throw new Error('Supabase client not initialized');
                }
                
                const task = tasks.find(t => t.id === taskId);
                if (!task) throw new Error('Task not found');
                
                const { error } = await supabaseClient
                    .from('tasks')
                    .update({ 
                        deleted_at: new Date().toISOString(),
                        history: [...(task.history || []), 
                                 `${new Date().toLocaleString()}: Deleted by ${currentUser}`]
                    })
                    .eq('id', taskId);
                
                if (error) throw error;
                
                // Invalidate both tasks and deleted tasks caches
                clearCache('tasks');
                clearCache('deletedTasks');
                
                return true;
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('Error deleting task from database');
                return false;
            }
        }
        
        // Restore deleted task
        async function restoreTask(taskId) {
            try {
                if (!supabaseClient) {
                    throw new Error('Supabase client not initialized');
                }
                
                const task = deletedTasks.find(t => t.id === taskId);
                if (!task) throw new Error('Task not found');
                
                const { error } = await supabaseClient
                    .from('tasks')
                    .update({ 
                        deleted_at: null,
                        history: [...(task.history || []), 
                                 `${new Date().toLocaleString()}: Restored by ${currentUser}`]
                    })
                    .eq('id', taskId);
                
                if (error) throw error;
                
                // Invalidate both tasks and deleted tasks caches
                clearCache('tasks');
                clearCache('deletedTasks');
                
                return true;
            } catch (error) {
                console.error('Error restoring task:', error);
                alert('Error restoring task');
                return false;
            }
        }
        
        // Save user to Supabase (and update cache) - FIXED PASSWORD STORAGE
        async function saveUserToSupabase(user, isUpdate = false) {
            try {
                if (!supabaseClient) {
                    throw new Error('Supabase client not initialized');
                }
                
                // Prepare user data
                const userData = {
                    username: user.username.trim(),
                    full_name: user.fullName ? user.fullName.trim() : null,
                    email: user.email ? user.email.trim() : null,
                    role: user.role,
                    is_active: user.status === 'true',
                    updated_at: new Date().toISOString()
                };
                
                // Hash password for new users
                if (!isUpdate && user.password) {
                    if (user.password.length < 6) {
                        throw new Error('Password must be at least 6 characters long');
                    }
                    userData.password_hash = await hashPassword(user.password);
                }
                
                // Hash password for password reset
                if (isUpdate && user.password) {
                    if (user.password.length < 6) {
                        throw new Error('Password must be at least 6 characters long');
                    }
                    userData.password_hash = await hashPassword(user.password);
                }
                
                let result;
                if (isUpdate) {
                    result = await supabaseClient
                        .from('users')
                        .update(userData)
                        .eq('id', user.id);
                } else {
                    result = await supabaseClient
                        .from('users')
                        .insert([userData]);
                }
                
                const { error } = result;
                if (error) throw error;
                
                // Invalidate users cache
                clearCache('users');
                
                return true;
            } catch (error) {
                console.error('Error saving user:', error);
                alert(`Error saving user to database: ${error.message}`);
                return false;
            }
        }
        
        // Change user password (FIXED - properly updates database)
        async function changeUserPassword(userId, newPassword) {
            try {
                if (!supabaseClient) {
                    throw new Error('Supabase client not initialized');
                }
                
                if (newPassword.length < 6) {
                    throw new Error('Password must be at least 6 characters long');
                }
                
                // Hash the new password
                const hashedPassword = await hashPassword(newPassword);
                
                // Update password in database
                const { error } = await supabaseClient
                    .from('users')
                    .update({ 
                        password_hash: hashedPassword,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', userId);
                
                if (error) throw error;
                
                // Invalidate users cache
                clearCache('users');
                
                return true;
            } catch (error) {
                console.error('Error changing password:', error);
                alert(`Error changing password: ${error.message}`);
                return false;
            }
        }
        
        // Change current user's password
        async function changeCurrentUserPassword(currentPassword, newPassword) {
            try {
                // First verify current password
                const { data: userData, error: fetchError } = await supabaseClient
                    .from('users')
                    .select('password_hash')
                    .eq('id', currentUserId)
                    .single();
                
                if (fetchError) throw fetchError;
                
                const isCurrentPasswordValid = await verifyPassword(currentPassword, userData.password_hash);
                if (!isCurrentPasswordValid) {
                    throw new Error('Current password is incorrect');
                }
                
                // Change to new password
                return await changeUserPassword(currentUserId, newPassword);
            } catch (error) {
                console.error('Error changing password:', error);
                throw error;
            }
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                currentUserRole = null;
                currentUserId = null;
                currentUserFullName = null;
                document.getElementById('appContainer').classList.add('hidden');
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('adminMenu').classList.add('hidden');
                document.getElementById('loginForm').reset();
                
                // Clear all caches on logout
                clearCache();
            }
        }
        
        // UI Functions
        function toggleMenu() { 
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileMenuOverlay');
            
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }
        
        function setPage(name) {
            document.getElementById('pageTitle').textContent = name;
            
            // Close mobile menu
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('mobileMenuOverlay').classList.add('hidden');
            
            // Hide user profile dropdown
            document.getElementById('userProfileDropdown').classList.add('hidden');
            
            // Hide all special containers
            document.getElementById('usersTableContainer').classList.add('hidden');
            document.getElementById('deletedTasksContainer').classList.add('hidden');
            
            // Show appropriate container
            if (name === 'Manage Users') {
                document.getElementById('usersTableContainer').classList.remove('hidden');
                renderUsersTable();
            } else if (name === 'Deleted Tasks') {
                document.getElementById('deletedTasksContainer').classList.remove('hidden');
                loadDeletedTasks();
            }
            
            // Update active menu button
            document.querySelectorAll('.menuBtn').forEach(b => {
                b.classList.remove('bg-blue-600', 'text-white');
                b.classList.add('hover:bg-gray-100', 'text-gray-700');
                
                const buttonText = b.querySelector('span').textContent;
                if (buttonText === name) {
                    b.classList.add('bg-blue-600', 'text-white');
                    b.classList.remove('hover:bg-gray-100', 'text-gray-700');
                }
            });
            
            if (name !== 'Manage Users' && name !== 'Deleted Tasks') {
                render();
            }
        }
        
        // Task Functions
        function openAdd() {
            document.getElementById('editId').value = '';
            document.getElementById('modalTitle').textContent = 'Add New Task';
            document.getElementById('taskForm').reset();
            
            // Set default assigned to as current user
            document.getElementById('assignedTo').value = currentUser;
            
            document.getElementById('taskModal').classList.replace('hidden', 'flex');
        }
        
        function openEdit(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            document.getElementById('editId').value = taskId;
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('assignedBy').value = task.by || '';
            document.getElementById('assignedTo').value = task.to;
            document.getElementById('notes').value = task.note;
            document.getElementById('modalTitle').textContent = 'Edit Task';
            document.getElementById('taskModal').classList.replace('hidden', 'flex');
        }
        
        function closeModal() { 
            document.getElementById('taskModal').classList.replace('flex', 'hidden'); 
        }
        
        async function saveTask(e) {
            e.preventDefault();
            
            // Show loading
            document.getElementById('saveBtnText').textContent = 'Saving...';
            document.getElementById('saveLoading').classList.remove('hidden');
            
            // Validation
            const assignedTo = document.getElementById('assignedTo').value;
            if (!assignedTo) {
                alert('Please select someone to assign the task to');
                document.getElementById('saveBtnText').textContent = 'Save Task';
                document.getElementById('saveLoading').classList.add('hidden');
                return;
            }
            
            const taskId = document.getElementById('editId').value;
            const now = new Date().toLocaleString();
            let taskIndex = -1;
            let task = null;
            
            const assignedBy = document.getElementById('assignedBy').value;
            
            if (taskId !== '') { // Edit
                taskIndex = tasks.findIndex(t => t.id === taskId);
                if (taskIndex === -1) return;
                
                task = tasks[taskIndex];
                task.title = document.getElementById('taskTitle').value;
                task.by = assignedBy || currentUser;
                task.to = assignedTo;
                task.note = document.getElementById('notes').value;
                
                // If task was done and being edited, reset done status
                if (task.status === 'Done') {
                    task.status = 'Pending';
                    task.doneAt = '';
                    task.doneBy = '';
                    task.doneNote = '';
                    task.history.push(`${now}: Reopened by ${currentUser}`);
                } else {
                    task.history.push(`${now}: Edited by ${currentUser}`);
                }
                
                // Update in Supabase
                const success = await saveTaskToSupabase(task, true);
                if (!success) {
                    document.getElementById('saveBtnText').textContent = 'Save Task';
                    document.getElementById('saveLoading').classList.add('hidden');
                    return;
                }
                
            } else { // Add
                const newTaskId = await generateTaskId();
                task = {
                    id: '', // Will be set by Supabase
                    task_id: newTaskId,
                    title: document.getElementById('taskTitle').value,
                    by: assignedBy || currentUser,
                    to: assignedTo,
                    note: document.getElementById('notes').value,
                    assignedAt: now,
                    doneAt: '',
                    doneBy: '',
                    doneNote: '',
                    status: 'Pending',
                    history: [`${now}: Created by ${currentUser}`]
                };
                
                // Save to Supabase first
                const success = await saveTaskToSupabase(task, false);
                if (!success) {
                    document.getElementById('saveBtnText').textContent = 'Save Task';
                    document.getElementById('saveLoading').classList.add('hidden');
                    return;
                }
                
                // Clear cache and reload tasks
                clearCache('tasks');
                await loadTasks(true);
            }
            
            // Reset button
            document.getElementById('saveBtnText').textContent = 'Save Task';
            document.getElementById('saveLoading').classList.add('hidden');
            
            closeModal();
            render();
        }
        
        // Render Function
        async function render() {
            // Refresh data from cache/database
            await loadTasks();
            
            const pageTitle = document.getElementById('pageTitle').textContent;
            
            // Sort tasks: Pending first, then by date (newest first)
            const sortedTasks = [...tasks].sort((a, b) => {
                if (a.status === 'Pending' && b.status !== 'Pending') return -1;
                if (a.status !== 'Pending' && b.status === 'Pending') return 1;
                return new Date(b.assignedAt) - new Date(a.assignedAt);
            });
            
            let filtered = sortedTasks;
            
            if (pageTitle === 'My Tasks') {
                filtered = sortedTasks.filter(t => t.to === currentUser && t.status !== 'Done');
            } else if (pageTitle === 'Done by Me') {
                filtered = sortedTasks.filter(t => t.status === 'Done' && t.doneBy === currentUser);
            }
            
            // Update pending tasks summary
            updatePendingSummary();
            
            // Render main table
            renderTable(filtered);
            renderMobileCards(filtered);
            
            // Show empty state if no tasks
            if (filtered.length === 0) {
                showEmptyState(pageTitle);
            }
        }
        
        function updatePendingSummary() {
            const pendingTasks = tasks.filter(t => t.status === 'Pending');
            const pendingCount = document.getElementById('pendingCount');
            const pendingList = document.getElementById('pendingTasksList');
            
            pendingCount.textContent = pendingTasks.length;
            
            if (pendingTasks.length === 0) {
                pendingList.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <p>No pending tasks</p>
                    </div>`;
                return;
            }
            
            pendingList.innerHTML = pendingTasks.slice(0, 5).map(task => `
                <div class="flex items-center justify-between p-2 border rounded hover:bg-gray-50">
                    <div class="flex-1 min-w-0">
                        <div class="font-medium text-sm truncate">${task.title}</div>
                        <div class="text-xs text-gray-500 truncate">
                            <span class="font-medium">${task.to}</span> • ${task.assignedAt}
                        </div>
                    </div>
                    ${task.to === currentUser ? 
                        `<button onclick="openMarkDone('${task.id}')" 
                                class="ml-2 text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700 whitespace-nowrap">
                            ✅ Done
                        </button>` : 
                        ''
                    }
                </div>
            `).join('');
            
            if (pendingTasks.length > 5) {
                pendingList.innerHTML += `
                    <div class="text-center py-2 text-sm text-gray-500">
                        +${pendingTasks.length - 5} more pending tasks
                    </div>`;
            }
        }
        
        function renderTable(filteredTasks) {
            const taskTable = document.getElementById('taskTable');
            
            taskTable.innerHTML = filteredTasks.map(task => {
                // Status display with Done by user
                let statusDisplay = '';
                if (task.status === 'Done') {
                    statusDisplay = `
                        <div class="space-y-1">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200 whitespace-nowrap">
                                <span class="w-1.5 h-1.5 bg-green-600 rounded-full mr-1.5"></span>
                                Done
                            </span>
                            <div class="text-xs text-gray-500 truncate">By: ${task.doneBy}</div>
                        </div>`;
                } else {
                    statusDisplay = `
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200 whitespace-nowrap">
                            <span class="w-1.5 h-1.5 bg-yellow-600 rounded-full mr-1.5"></span>
                            Pending
                        </span>`;
                }
                
                // Task title and notes with proper line breaks
                const taskTitle = task.title || '';
                const taskNotes = task.note || '';
                
                return `
                <tr class="border-t hover:bg-gray-50 transition ${task.status === 'Pending' ? 'bg-white' : 'bg-gray-50/50'}">
                    <td class="p-3 font-mono text-xs font-bold whitespace-nowrap">${task.task_id}</td>
                    <td class="p-3 font-medium task-cell" style="min-width: 200px; max-width: 300px; word-wrap: break-word; white-space: normal;">
                        ${taskTitle.replace(/\n/g, '<br>')}
                    </td>
                    <td class="p-3 task-cell" style="min-width: 120px;">
                        ${task.by || '--'}
                    </td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded-full text-xs ${task.to === currentUser ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-700'} whitespace-nowrap">
                            ${task.to}
                        </span>
                    </td>
                    <td class="p-3 text-xs text-gray-500 whitespace-nowrap">${task.assignedAt}</td>
                    <td class="p-3 text-xs text-gray-500 whitespace-nowrap">
                        ${task.doneAt || '--'}
                        ${task.doneNote ? `<div class="text-xs text-gray-400 mt-1 italic truncate">"${task.doneNote}"</div>` : ''}
                    </td>
                    <td class="p-3">${statusDisplay}</td>
                    <td class="p-3 text-sm text-gray-600 task-cell" style="min-width: 200px; max-width: 300px; word-wrap: break-word; white-space: normal;" title="${taskNotes}">
                        ${taskNotes.replace(/\n/g, '<br>') || '--'}
                    </td>
                    <td class="p-3">
                        <div class="flex gap-1 flex-wrap">
                            ${task.status !== 'Done' && task.to === currentUser ? 
                                `<button onclick="openMarkDone('${task.id}')" 
                                        class="p-2 hover:bg-green-100 rounded-lg transition" title="Mark Done">
                                    <i class="fas fa-check text-green-600"></i>
                                </button>` : 
                                task.status === 'Done' ? `<span class="p-2 text-gray-300"><i class="fas fa-check"></i></span>` : ''
                            }
                            <button onclick="openEdit('${task.id}')" 
                                    class="p-2 hover:bg-blue-100 rounded-lg transition" title="Edit">
                                <i class="fas fa-edit text-blue-600"></i>
                            </button>
                            ${task.status !== 'Done' ? 
                                `<button onclick="openHandover('${task.id}')" 
                                        class="p-2 hover:bg-purple-100 rounded-lg transition" title="Handover">
                                    <i class="fas fa-exchange-alt text-purple-600"></i>
                                </button>` : 
                                `<span class="p-2 text-gray-300"><i class="fas fa-exchange-alt"></i></span>`
                            }
                            <button onclick="viewHistory('${task.id}')" 
                                    class="p-2 hover:bg-yellow-100 rounded-lg transition" title="History">
                                <i class="fas fa-history text-yellow-600"></i>
                            </button>
                            <button onclick="deleteTask('${task.id}')" 
                                    class="p-2 hover:bg-red-100 rounded-lg transition" title="Delete">
                                <i class="fas fa-trash text-red-600"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }
        
        function renderMobileCards(filteredTasks) {
            const mobileTasks = document.getElementById('mobileTasks');
            
            mobileTasks.innerHTML = filteredTasks.map(task => {
                return `
                <div class="bg-white p-4 rounded-lg shadow space-y-3 hover:shadow-md transition ${task.status === 'Done' ? 'opacity-80' : ''}">
                    <div class="flex justify-between items-start">
                        <span class="text-xs font-mono font-bold bg-gray-100 px-2 py-1 rounded whitespace-nowrap">${task.task_id}</span>
                        <div class="text-right">
                            ${task.status === 'Done' ? 
                                `<div class="space-y-1">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 whitespace-nowrap">
                                        <span class="w-1.5 h-1.5 bg-green-600 rounded-full mr-1.5"></span>
                                        Done
                                    </span>
                                    <div class="text-xs text-gray-500 truncate">By: ${task.doneBy}</div>
                                </div>` :
                                `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 whitespace-nowrap">
                                    <span class="w-1.5 h-1.5 bg-yellow-600 rounded-full mr-1.5"></span>
                                    Pending
                                </span>`
                            }
                        </div>
                    </div>
                    
                    <h3 class="font-semibold text-lg break-words">${task.title}</h3>
                    
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="min-w-0">
                            <div class="text-gray-500 text-xs">Assigned By</div>
                            <div class="truncate">${task.by || '--'}</div>
                        </div>
                        <div class="min-w-0">
                            <div class="text-gray-500 text-xs">Assigned To</div>
                            <div class="px-2 py-1 rounded-full text-xs inline-block ${task.to === currentUser ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-700'} truncate">
                                ${task.to}
                            </div>
                        </div>
                        <div class="min-w-0">
                            <div class="text-gray-500 text-xs">Assigned At</div>
                            <div class="text-xs truncate">${task.assignedAt}</div>
                        </div>
                        <div class="min-w-0">
                            <div class="text-gray-500 text-xs">Done At</div>
                            <div class="text-xs truncate">${task.doneAt || '--'}</div>
                        </div>
                    </div>
                    
                    ${task.doneNote ? `
                    <div class="bg-green-50 border border-green-100 rounded p-2">
                        <div class="text-xs text-gray-500">Completion Note:</div>
                        <div class="text-sm italic break-words">"${task.doneNote}"</div>
                    </div>` : ''}
                    
                    <div class="pt-3 border-t">
                        <div class="text-xs text-gray-500 mb-1">Notes:</div>
                        <div class="text-sm break-words">${task.note || 'No notes'}</div>
                    </div>
                    
                    <div class="flex gap-2 pt-3 border-t flex-wrap">
                        ${task.status !== 'Done' && task.to === currentUser ? 
                            `<button onclick="openMarkDone('${task.id}')" 
                                    class="flex-1 border border-green-200 rounded-lg py-2 hover:bg-green-50 transition flex items-center justify-center gap-1 min-w-[120px]">
                                <i class="fas fa-check text-green-600"></i>
                                <span class="text-sm whitespace-nowrap">Done</span>
                            </button>` : 
                            task.status === 'Done' ? 
                            `<span class="flex-1 border border-gray-200 rounded-lg py-2 text-gray-400 text-center min-w-[120px]">✅ Done</span>` : 
                            `<span class="flex-1 border border-gray-200 rounded-lg py-2 text-gray-400 text-center min-w-[120px]">Not Assigned</span>`
                        }
                        
                        <button onclick="openEdit('${task.id}')" 
                                class="flex-1 border border-blue-200 rounded-lg py-2 hover:bg-blue-50 transition flex items-center justify-center gap-1 min-w-[120px]">
                            <i class="fas fa-edit text-blue-600"></i>
                            <span class="text-sm whitespace-nowrap">Edit</span>
                        </button>
                        
                        ${task.status !== 'Done' ? 
                            `<button onclick="openHandover('${task.id}')" 
                                    class="flex-1 border border-purple-200 rounded-lg py-2 hover:bg-purple-50 transition flex items-center justify-center gap-1 min-w-[120px]">
                                <i class="fas fa-exchange-alt text-purple-600"></i>
                                <span class="text-sm whitespace-nowrap">Handover</span>
                            </button>` : 
                            `<span class="flex-1 border border-gray-200 rounded-lg py-2 text-gray-400 text-center min-w-[120px]">🔄 Handover</span>`
                        }
                        
                        <button onclick="viewHistory('${task.id}')" 
                                class="flex-1 border border-yellow-200 rounded-lg py-2 hover:bg-yellow-50 transition flex items-center justify-center gap-1 min-w-[120px]">
                            <i class="fas fa-history text-yellow-600"></i>
                            <span class="text-sm whitespace-nowrap">History</span>
                        </button>
                        
                        <button onclick="deleteTask('${task.id}')" 
                                class="flex-1 border border-red-200 rounded-lg py-2 hover:bg-red-50 transition flex items-center justify-center gap-1 min-w-[120px]">
                            <i class="fas fa-trash text-red-600"></i>
                            <span class="text-sm whitespace-nowrap">Delete</span>
                        </button>
                    </div>
                </div>`;
            }).join('');
        }
        
        function renderUsersTable() {
            const usersTable = document.getElementById('usersTable');
            
            usersTable.innerHTML = users.map(user => {
                const lastLogin = user.last_login_at ? new Date(user.last_login_at).toLocaleString() : 'Never';
                
                return `
                <tr class="border-t hover:bg-gray-50 transition">
                    <td class="p-3 font-medium">${user.username}</td>
                    <td class="p-3">${user.full_name || '--'}</td>
                    <td class="p-3">${user.email || '--'}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded-full text-xs ${user.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-700'} whitespace-nowrap">
                            ${user.role}
                        </span>
                    </td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded-full text-xs ${user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} whitespace-nowrap">
                            ${user.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td class="p-3 text-xs text-gray-500 whitespace-nowrap">${new Date(user.created_at).toLocaleDateString()}</td>
                    <td class="p-3 text-xs text-gray-500 whitespace-nowrap">${lastLogin}</td>
                    <td class="p-3">
                        <div class="flex gap-1">
                            <button onclick="openEditUser('${user.id}')" 
                                    class="p-2 hover:bg-blue-100 rounded-lg transition" title="Edit">
                                <i class="fas fa-edit text-blue-600"></i>
                            </button>
                            <button onclick="resetUserPassword('${user.id}', '${user.username}')" 
                                    class="p-2 hover:bg-yellow-100 rounded-lg transition" title="Reset Password">
                                <i class="fas fa-key text-yellow-600"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }
        
        function renderDeletedTasks() {
            const deletedTasksTable = document.getElementById('deletedTasksTable');
            
            deletedTasksTable.innerHTML = deletedTasks.map(task => {
                return `
                <tr class="border-t hover:bg-gray-50 transition bg-red-50/50">
                    <td class="p-3 font-mono text-xs font-bold whitespace-nowrap">${task.task_id}</td>
                    <td class="p-3 font-medium break-words">${task.title}</td>
                    <td class="p-3 break-words">${task.by || '--'}</td>
                    <td class="p-3 whitespace-nowrap">${task.to}</td>
                    <td class="p-3 text-xs text-gray-500 whitespace-nowrap">${task.deletedAt}</td>
                    <td class="p-3">
                        <button onclick="restoreDeletedTask('${task.id}')" 
                                class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 flex items-center gap-1 whitespace-nowrap">
                            <i class="fas fa-undo"></i>
                            <span>Restore</span>
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }
        
        function showEmptyState(pageTitle) {
            const taskTable = document.getElementById('taskTable');
            const mobileTasks = document.getElementById('mobileTasks');
            
            const message = pageTitle === 'My Tasks' ? 'No pending tasks assigned to you' :
                           pageTitle === 'Done by Me' ? 'No tasks completed by you yet' :
                           'No tasks found';
            
            taskTable.innerHTML = `
                <tr>
                    <td colspan="9" class="p-8 text-center text-gray-500">
                        <div class="flex flex-col items-center">
                            <i class="fas fa-clipboard-list text-5xl mb-4 opacity-20"></i>
                            <p class="text-lg mb-2">${message}</p>
                            <p class="text-sm text-gray-400 mb-4">Get started by creating your first task</p>
                            ${pageTitle !== 'Done by Me' ? 
                                `<button onclick="openAdd()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                                    + Create New Task
                                </button>` : ''
                            }
                        </div>
                    </td>
                </tr>`;
            
            mobileTasks.innerHTML = `
                <div class="bg-white p-8 rounded-lg shadow text-center">
                    <i class="fas fa-clipboard-list text-5xl mb-4 opacity-20"></i>
                    <p class="text-lg text-gray-500 mb-2">${message}</p>
                    <p class="text-sm text-gray-400 mb-6">Get started by creating your first task</p>
                    ${pageTitle !== 'Done by Me' ? 
                        `<button onclick="openAdd()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                            + Create New Task
                        </button>` : ''
                    }
                </div>`;
        }
        
        // User Management Functions
        function openAddUser() {
            document.getElementById('editUserId').value = '';
            document.getElementById('userModalTitle').textContent = 'Add New User';
            document.getElementById('userForm').reset();
            document.getElementById('userStatus').value = 'true';
            document.getElementById('passwordFields').classList.remove('hidden');
            document.getElementById('userModal').classList.replace('hidden', 'flex');
        }
        
        function openEditUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('editUserId').value = userId;
            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('username').value = user.username;
            document.getElementById('fullName').value = user.full_name || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('userRole').value = user.role;
            document.getElementById('userStatus').value = user.is_active ? 'true' : 'false';
            document.getElementById('passwordFields').classList.add('hidden');
            document.getElementById('userModal').classList.replace('hidden', 'flex');
        }
        
        function closeUserModal() {
            document.getElementById('userModal').classList.replace('flex', 'hidden');
        }
        
        async function saveUser(e) {
            e.preventDefault();
            
            // Show loading
            document.getElementById('saveUserBtnText').textContent = 'Saving...';
            document.getElementById('saveUserLoading').classList.remove('hidden');
            
            const userId = document.getElementById('editUserId').value;
            const isUpdate = userId !== '';
            
            const userData = {
                username: document.getElementById('username').value.trim(),
                fullName: document.getElementById('fullName').value.trim(),
                email: document.getElementById('email').value.trim(),
                role: document.getElementById('userRole').value,
                status: document.getElementById('userStatus').value
            };
            
            if (!isUpdate) {
                // New user - get password
                userData.password = document.getElementById('password').value;
                if (!userData.password || userData.password.length < 6) {
                    alert('Password must be at least 6 characters long');
                    document.getElementById('saveUserBtnText').textContent = 'Save User';
                    document.getElementById('saveUserLoading').classList.add('hidden');
                    return;
                }
            }
            
            if (isUpdate) {
                const existingUser = users.find(u => u.id === userId);
                if (existingUser) {
                    userData.id = userId;
                }
            }
            
            const success = await saveUserToSupabase(userData, isUpdate);
            
            // Reset button
            document.getElementById('saveUserBtnText').textContent = 'Save User';
            document.getElementById('saveUserLoading').classList.add('hidden');
            
            if (success) {
                await loadUsers(true);
                closeUserModal();
                if (document.getElementById('pageTitle').textContent === 'Manage Users') {
                    renderUsersTable();
                }
            }
        }
        
        async function resetUserPassword(userId, username) {
            const newPassword = prompt(`Enter new password for user "${username}":`, '123456');
            if (!newPassword) return;
            
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }
            
            if (confirm(`Are you sure you want to reset password for user "${username}"?`)) {
                const success = await changeUserPassword(userId, newPassword);
                if (success) {
                    alert(`Password reset successfully for user "${username}"`);
                }
            }
        }
        
        // Change Password Functions (FIXED - properly updates database)
        function openChangePassword() {
            document.getElementById('changePasswordForm').reset();
            document.getElementById('changePasswordModal').classList.replace('hidden', 'flex');
            // Hide user profile dropdown
            document.getElementById('userProfileDropdown').classList.add('hidden');
        }
        
        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.replace('flex', 'hidden');
        }
        
        async function changePassword(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validation
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match!');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('New password must be at least 6 characters long!');
                return;
            }
            
            // Show loading
            document.getElementById('changePasswordBtnText').textContent = 'Changing...';
            document.getElementById('changePasswordLoading').classList.remove('hidden');
            
            try {
                // Change password in database (FIXED)
                const success = await changeCurrentUserPassword(currentPassword, newPassword);
                
                if (success) {
                    alert('Password changed successfully!');
                    closeChangePasswordModal();
                }
            } catch (error) {
                alert(error.message || 'Error changing password');
            }
            
            // Reset button
            document.getElementById('changePasswordBtnText').textContent = 'Change Password';
            document.getElementById('changePasswordLoading').classList.add('hidden');
        }
        
        // Task Management Functions
        function openMarkDone(taskId) {
            currentDoneId = taskId;
            document.getElementById('doneNote').value = '';
            document.getElementById('doneModal').classList.replace('hidden', 'flex');
        }
        
        function closeDoneModal() {
            document.getElementById('doneModal').classList.replace('flex', 'hidden');
        }
        
        async function confirmMarkDone() {
            // Show loading
            document.getElementById('doneBtnText').textContent = 'Saving...';
            document.getElementById('doneLoading').classList.remove('hidden');
            
            const taskIndex = tasks.findIndex(t => t.id === currentDoneId);
            if (taskIndex === -1) {
                document.getElementById('doneBtnText').textContent = 'Mark Complete';
                document.getElementById('doneLoading').classList.add('hidden');
                return;
            }
            
            const task = tasks[taskIndex];
            const doneNote = document.getElementById('doneNote').value;
            const now = new Date().toLocaleString();
            
            task.status = 'Done';
            task.doneAt = now;
            task.doneBy = currentUser;
            task.doneNote = doneNote;
            task.history.push(`${now}: Marked as Done by ${currentUser}${doneNote ? ' - Note: ' + doneNote : ''}`);
            
            // Update in Supabase
            const success = await saveTaskToSupabase(task, true);
            
            // Reset button
            document.getElementById('doneBtnText').textContent = 'Mark Complete';
            document.getElementById('doneLoading').classList.add('hidden');
            
            if (success) {
                closeDoneModal();
                render();
            }
        }
        
        async function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task? This action cannot be undone.')) {
                const success = await softDeleteTask(taskId);
                if (success) {
                    await loadTasks(true);
                    render();
                }
            }
        }
        
        async function restoreDeletedTask(taskId) {
            if (confirm('Are you sure you want to restore this task?')) {
                const success = await restoreTask(taskId);
                if (success) {
                    await loadDeletedTasks(true);
                    await loadTasks(true);
                    if (document.getElementById('pageTitle').textContent !== 'Deleted Tasks') {
                        render();
                    }
                }
            }
        }
        
        // Handover functions
        function openHandover(taskId) { 
            currentHandoverId = taskId; 
            document.getElementById('handoverModal').classList.replace('hidden', 'flex'); 
        }
        
        function closeHandover() { 
            document.getElementById('handoverModal').classList.replace('flex', 'hidden'); 
        }
        
        async function confirmHandover() {
            // Show loading
            document.getElementById('handoverBtnText').textContent = 'Processing...';
            document.getElementById('handoverLoading').classList.remove('hidden');
            
            const taskIndex = tasks.findIndex(t => t.id === currentHandoverId);
            if (taskIndex === -1) {
                document.getElementById('handoverBtnText').textContent = 'Confirm Handover';
                document.getElementById('handoverLoading').classList.add('hidden');
                return;
            }
            
            const task = tasks[taskIndex];
            const old = task.to;
            const neu = document.getElementById('handoverTo').value;
            const now = new Date().toLocaleString();
            
            task.history.push(`${now}: Handover from ${old} to ${neu} by ${currentUser}`);
            task.to = neu;
            task.status = 'Pending';
            task.doneAt = '';
            task.doneBy = '';
            task.doneNote = '';
            
            // Update in Supabase
            const success = await saveTaskToSupabase(task, true);
            
            // Reset button
            document.getElementById('handoverBtnText').textContent = 'Confirm Handover';
            document.getElementById('handoverLoading').classList.add('hidden');
            
            if (success) {
                closeHandover();
                render();
            }
        }
        
        // History functions
        function viewHistory(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const historyList = document.getElementById('historyList');
            
            historyList.innerHTML = '';
            
            // Show basic info
            historyList.innerHTML += `
                <div class="p-4 border-b bg-blue-50 rounded-lg mb-3">
                    <div class="font-medium text-lg mb-2 break-words">${task.title}</div>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="text-gray-600">Task ID:</div>
                        <div class="font-mono font-bold">${task.task_id}</div>
                        <div class="text-gray-600">Status:</div>
                        <div class="${task.status === 'Done' ? 'text-green-600' : 'text-yellow-600'} font-medium">${task.status}</div>
                        <div class="text-gray-600">Assigned by:</div>
                        <div class="break-words">${task.by || '--'}</div>
                        <div class="text-gray-600">Assigned to:</div>
                        <div>${task.to}</div>
                    </div>
                </div>`;
            
            if (task.history.length === 0) {
                historyList.innerHTML += `
                    <div class="text-center py-8">
                        <i class="fas fa-history text-4xl mb-3 opacity-20"></i>
                        <p class="text-gray-500">No history available</p>
                    </div>`;
            } else {
                historyList.innerHTML += '<div class="text-sm font-medium mb-2">Activity Log:</div>';
                task.history.forEach(item => {
                    historyList.innerHTML += `
                        <div class="p-3 border-b text-sm bg-gray-50 rounded-lg mb-2">
                            <div class="flex items-start">
                                <div class="w-2 h-2 bg-blue-600 rounded-full mt-1.5 mr-2 flex-shrink-0"></div>
                                <div class="break-words">${item}</div>
                            </div>
                        </div>`;
                });
            }
            
            document.getElementById('historyModal').classList.replace('hidden', 'flex');
        }
        
        function closeHistory() {
            document.getElementById('historyModal').classList.replace('flex', 'hidden');
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Test database connection on page load
            testDatabaseConnection();
            
            // Modal close handlers
            const modals = ['taskModal', 'handoverModal', 'historyModal', 'doneModal', 'userModal', 'changePasswordModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('click', function(e) {
                        if (e.target === this) {
                            switch(modalId) {
                                case 'taskModal': closeModal(); break;
                                case 'handoverModal': closeHandover(); break;
                                case 'historyModal': closeHistory(); break;
                                case 'doneModal': closeDoneModal(); break;
                                case 'userModal': closeUserModal(); break;
                                case 'changePasswordModal': closeChangePasswordModal(); break;
                            }
                        }
                    });
                }
            });
            
            // Close user profile dropdown when clicking outside
            document.addEventListener('click', function(e) {
                const profileDropdown = document.getElementById('userProfileDropdown');
                const profileToggle = document.querySelector('button[onclick="toggleUserProfile()"]');
                
                if (profileDropdown && !profileDropdown.classList.contains('hidden')) {
                    if (!profileDropdown.contains(e.target) && !profileToggle.contains(e.target)) {
                        profileDropdown.classList.add('hidden');
                    }
                }
            });
            
            // Auto-refresh every 30 seconds
            setInterval(async () => {
                if (currentUser) {
                    await loadTasks();
                    const currentPage = document.getElementById('pageTitle').textContent;
                    if (currentPage !== 'Manage Users' && currentPage !== 'Deleted Tasks') {
                        render();
                    }
                }
            }, 30000);
            
            // Handle window resize for better web view
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    // Force re-render on resize for better responsiveness
                    if (currentUser && document.getElementById('pageTitle').textContent !== 'Manage Users' && document.getElementById('pageTitle').textContent !== 'Deleted Tasks') {
                        render();
                    }
                }, 250);
            });
        });
        
        // Export for manual cache clearing if needed
        window.clearAppCache = function() {
            clearCache();
            alert('All caches cleared successfully');
        };
        
        // Export for force refresh
        window.forceRefresh = async function() {
            if (confirm('Force refresh all data from database?')) {
                clearCache();
                await loadUsers(true);
                await loadTasks(true);
                await loadDeletedTasks(true);
                render();
                alert('Data refreshed from database');
            }
        };
    </script>
</body>
</html>
